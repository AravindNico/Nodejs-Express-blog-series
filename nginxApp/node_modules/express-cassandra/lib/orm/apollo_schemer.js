'use strict';

var TYPE_MAP = require('./cassandra_types');
var _ = require('lodash');
var util = require('util');

var schemer = {
  normalize_model_schema: function normalize_model_schema(modelSchema) {
    var outputSchema = _.cloneDeep(modelSchema, true);
    var goodFields = {
      fields: true,
      key: true,
      clustering_order: true,
      materialized_views: true,
      indexes: true,
      custom_index: true,
      custom_indexes: true
    };

    Object.keys(outputSchema).forEach(function (k) {
      if (!(k in goodFields)) delete outputSchema[k];
    });

    Object.keys(outputSchema.fields).forEach(function (k) {
      if (typeof outputSchema.fields[k] === 'string') {
        outputSchema.fields[k] = { type: outputSchema.fields[k] };
      } else if (outputSchema.fields[k]) {
        if (outputSchema.fields[k].virtual) {
          delete outputSchema.fields[k];
        } else if (outputSchema.fields[k].typeDef) {
          outputSchema.fields[k] = { type: outputSchema.fields[k].type, typeDef: outputSchema.fields[k].typeDef };
        } else {
          outputSchema.fields[k] = { type: outputSchema.fields[k].type };
        }
      } else {
        throw 'schema field "%s" is not properly defined: %s', k, outputSchema.fields[k];
      }

      if (outputSchema.fields[k] && outputSchema.fields[k].type === 'varchar') {
        outputSchema.fields[k].type = 'text';
      }

      if (outputSchema.fields[k] && ['map', 'list', 'set', 'frozen'].indexOf(outputSchema.fields[k].type) > -1) {
        if (modelSchema.typeMaps && modelSchema.typeMaps[k]) {
          outputSchema.fields[k].typeDef = modelSchema.typeMaps[k];
        } else {
          // eslint-disable-next-line max-len
          outputSchema.fields[k].typeDef = outputSchema.fields[k].typeDef.replace(/[\s]/g, '').replace(/varchar/g, 'text');
        }
      }

      if (modelSchema.staticMaps && modelSchema.staticMaps[k] === true) {
        outputSchema.fields[k].static = true;
      } else if (modelSchema.fields[k].static) {
        outputSchema.fields[k].static = true;
      }
    });

    if (outputSchema.key && typeof outputSchema.key[0] === 'string') {
      outputSchema.key[0] = [outputSchema.key[0]];
    }

    if (outputSchema.key && outputSchema.key.length) {
      for (var i = 1; i < outputSchema.key.length; i++) {
        if (!outputSchema.clustering_order) outputSchema.clustering_order = {};
        if (!outputSchema.clustering_order[outputSchema.key[i]]) {
          outputSchema.clustering_order[outputSchema.key[i]] = 'ASC';
        }

        // eslint-disable-next-line max-len
        outputSchema.clustering_order[outputSchema.key[i]] = outputSchema.clustering_order[outputSchema.key[i]].toUpperCase();
      }
    }

    var arraySort = function arraySort(a, b) {
      if (a > b) return 1;
      if (a < b) return -1;
      return 0;
    };

    if (outputSchema.materialized_views) {
      Object.keys(outputSchema.materialized_views).forEach(function (mvindex) {
        var outputMView = outputSchema.materialized_views[mvindex];
        // make parition key an array
        if (outputMView.key && typeof outputMView.key[0] === 'string') {
          outputMView.key[0] = [outputMView.key[0]];
        }

        // add clustering_order for all clustering keys
        if (outputMView.key && outputMView.key.length) {
          for (var _i = 1; _i < outputMView.key.length; _i++) {
            if (!outputMView.clustering_order) {
              outputMView.clustering_order = {};
            }
            if (!outputMView.clustering_order[outputMView.key[_i]]) {
              outputMView.clustering_order[outputMView.key[_i]] = 'ASC';
            }
            // eslint-disable-next-line max-len
            outputMView.clustering_order[outputMView.key[_i]] = outputMView.clustering_order[outputMView.key[_i]].toUpperCase();
          }
        }

        // add all non existent primary key items to select and sort them
        for (var pkeyIndex = 0; pkeyIndex < outputMView.key.length; pkeyIndex++) {
          if (pkeyIndex === 0) {
            for (var partitionIndex = 0; partitionIndex < outputMView.key[pkeyIndex].length; partitionIndex++) {
              if (outputMView.select.indexOf(outputMView.key[pkeyIndex][partitionIndex]) === -1) {
                outputMView.select.push(outputMView.key[pkeyIndex][partitionIndex]);
              }
            }
          } else if (outputMView.select.indexOf(outputMView.key[pkeyIndex]) === -1) {
            outputMView.select.push(outputMView.key[pkeyIndex]);
          }
        }

        // check if select has * and then add all fields to select
        if (outputMView.select[0] === '*') {
          outputMView.select = Object.keys(outputSchema.fields);
        }

        outputMView.select.sort(arraySort);
      });
    } else {
      outputSchema.materialized_views = {};
    }

    if (outputSchema.indexes) {
      for (var _i2 = 0; _i2 < outputSchema.indexes.length; _i2++) {
        var indexNameList = outputSchema.indexes[_i2].replace(/["\s]/g, '').split(/[()]/g);
        if (indexNameList.length > 1) {
          indexNameList[0] = indexNameList[0].toLowerCase();
          if (indexNameList[0] === 'values') outputSchema.indexes[_i2] = indexNameList[1];else outputSchema.indexes[_i2] = util.format('%s(%s)', indexNameList[0], indexNameList[1]);
        } else {
          outputSchema.indexes[_i2] = indexNameList[0];
        }
      }
      outputSchema.indexes.sort(arraySort);
    } else {
      outputSchema.indexes = [];
    }

    if (outputSchema.custom_index) {
      outputSchema.custom_indexes = [outputSchema.custom_index];
      delete outputSchema.custom_index;
    }

    if (outputSchema.custom_indexes) {
      var customArraySort = function customArraySort(a, b) {
        if (a.on > b.on) return 1;
        if (a.on < b.on) return -1;

        if (a.using > b.using) return 1;
        if (a.using < b.using) return -1;

        if (a.options > b.options) return 1;
        if (a.options < b.options) return -1;

        return 0;
      };

      outputSchema.custom_indexes.sort(customArraySort);
    } else {
      outputSchema.custom_indexes = [];
    }

    return outputSchema;
  },
  validate_model_schema: function validate_model_schema(modelSchema) {
    var _this = this;

    if (!modelSchema) throw new Error('A schema must be specified');

    if (!_.isPlainObject(modelSchema.fields) || Object.keys(modelSchema.fields).length === 0) {
      throw new Error('Schema must contain a non-empty "fields" map object');
    }

    if (!modelSchema.key || !(modelSchema.key instanceof Array)) {
      throw new Error('Schema must contain "key" in the form: [ [partitionkey1, ...], clusteringkey1, ...]');
    }

    Object.keys(modelSchema.fields).forEach(function (k) {
      var fieldtype = _this.get_field_type(modelSchema, k);
      if (!(fieldtype in TYPE_MAP)) {
        throw new Error(util.format('Given schema field type is not supported for: %s(%s)', k, modelSchema.fields[k].type));
      }
      if (!_this.is_field_default_value_valid(modelSchema, k)) {
        throw new Error(util.format('Invalid defult definition for: %s(%s)', k, modelSchema.fields[k].type));
      }
    });

    // validate primary key
    if (typeof modelSchema.key[0] === 'string') {
      if (!(modelSchema.key[0] in modelSchema.fields)) {
        throw new Error('Partition Key must also be a valid field name');
      }
      if (modelSchema.fields[modelSchema.key[0]].virtual) {
        throw new Error("Partition Key must also be a db field name, can't be a virtual field name");
      }
    } else if (modelSchema.key[0] instanceof Array) {
      if (modelSchema.key[0].length === 0) {
        throw new Error("Partition Key array can't be empty");
      }
      for (var j = 0; j < modelSchema.key[0].length; j++) {
        if (typeof modelSchema.key[0][j] !== 'string' || !(modelSchema.key[0][j] in modelSchema.fields)) {
          throw new Error('Partition Key array must contain only valid field names');
        }
        if (modelSchema.fields[modelSchema.key[0][j]].virtual) {
          throw new Error("Partition Key array must contain only db field names, can't contain virtual field names");
        }
      }
    } else {
      throw new Error('Partition Key must be a field name string, or array of field names');
    }

    for (var i = 0; i < modelSchema.key.length; i++) {
      if (i > 0) {
        if (typeof modelSchema.key[i] !== 'string' || !(modelSchema.key[i] in modelSchema.fields)) {
          throw new Error('Clustering Keys must be valid field names');
        }
        if (modelSchema.fields[modelSchema.key[i]].virtual) {
          throw new Error("Clustering Keys must be db field names, can't be virtual field names");
        }
      }
    }

    if (modelSchema.clustering_order) {
      if (!_.isPlainObject(modelSchema.clustering_order)) {
        throw new Error('clustering_order must be an object of clustering_key attributes');
      }

      Object.keys(modelSchema.clustering_order).forEach(function (cindex) {
        if (['asc', 'desc'].indexOf(modelSchema.clustering_order[cindex].toLowerCase()) === -1) {
          throw new Error('clustering_order attribute values can only be ASC or DESC');
        }
        if (modelSchema.key.indexOf(cindex) < 1) {
          throw new Error('clustering_order field attributes must be clustering keys only');
        }
      });
    }

    // validate materialized_view
    if (modelSchema.materialized_views) {
      if (!_.isPlainObject(modelSchema.materialized_views)) {
        throw new Error('materialized_views must be an object with view names as attributes');
      }

      Object.keys(modelSchema.materialized_views).forEach(function (mvindex) {
        var candidateMView = modelSchema.materialized_views[mvindex];
        if (!_.isPlainObject(candidateMView)) {
          throw new Error(util.format('attribute "%s" under materialized_views must be an object', mvindex));
        }

        if (!candidateMView.select || !candidateMView.key) {
          throw new Error(util.format('materialized_view "%s" must have "select" and "key" attributes', mvindex));
        }

        if (!(candidateMView.select instanceof Array) || !(candidateMView.key instanceof Array)) {
          throw '"select" and "key" attributes must be an array under attribute %s of materialized_views', mvindex;
        }

        for (var selectindex = 0; selectindex < candidateMView.select.length; selectindex++) {
          if (typeof candidateMView.select[selectindex] !== 'string' || !(candidateMView.select[selectindex] in modelSchema.fields || candidateMView.select[selectindex] === '*')) {
            throw new Error(util.format('the select attribute under materialized_view %s must be an array of field name strings or ["*"]', mvindex));
          }

          if (modelSchema.fields[candidateMView.select[selectindex]] && modelSchema.fields[candidateMView.select[selectindex]].virtual) {
            throw new Error(util.format('the select attribute under %s of materialized_views must be an array of db field names, ' + 'cannot contain any virtual field name', mvindex));
          }
        }

        // validate materialized_view primary key
        if (typeof candidateMView.key[0] === 'string') {
          if (!(candidateMView.key[0] in modelSchema.fields)) {
            throw new Error(util.format('materialized_view %s: partition key string must match a valid field name', mvindex));
          }
          if (modelSchema.fields[candidateMView.key[0]].virtual) {
            throw new Error(util.format('materialized_view %s: partition key must match a db field name, cannot be a virtual field name', mvindex));
          }
        } else if (candidateMView.key[0] instanceof Array) {
          if (candidateMView.key[0].length === 0) {
            throw new Error(util.format('materialized_view %s: partition key array cannot be empty', mvindex));
          }
          for (var _j = 0; _j < candidateMView.key[0].length; _j++) {
            if (typeof candidateMView.key[0][_j] !== 'string' || !(candidateMView.key[0][_j] in modelSchema.fields)) {
              throw new Error(util.format('materialized_view %s: partition key array must contain only valid field names', mvindex));
            }
            if (modelSchema.fields[candidateMView.key[0][_j]].virtual) {
              throw new Error(util.format('materialized_view %s: partition key array must contain only db field names, ' + 'cannot contain virtual field names', mvindex));
            }
          }
        } else {
          throw new Error(util.format('materialized_view %s: partition key must be a field name string, or array of field names', mvindex));
        }

        for (var _i3 = 0; _i3 < candidateMView.key.length; _i3++) {
          if (_i3 > 0) {
            if (typeof candidateMView.key[_i3] !== 'string' || !(candidateMView.key[_i3] in modelSchema.fields)) {
              throw new Error(util.format('materialized_view %s: clustering keys must be valid field names', mvindex));
            }
            if (modelSchema.fields[candidateMView.key[_i3]].virtual) {
              throw new Error(util.format('materialized_view %s: clustering keys must be db field names, cannot contain virtual fields', mvindex));
            }
          }
        }

        if (candidateMView.clustering_order) {
          if (!_.isPlainObject(candidateMView.clustering_order)) {
            throw new Error(util.format('materialized_view %s: clustering_order must be an object of clustering_key attributes', mvindex));
          }

          Object.keys(candidateMView.clustering_order).forEach(function (cindex) {
            if (['asc', 'desc'].indexOf(candidateMView.clustering_order[cindex].toLowerCase()) === -1) {
              throw new Error(util.format('materialized_view %s: clustering_order attribute values can only be ASC or DESC', mvindex));
            }
            if (candidateMView.key.indexOf(cindex) < 1) {
              throw new Error(util.format('materialized_view %s: clustering_order field attributes must be clustering keys only', mvindex));
            }
          });
        }
      });
    }

    // validate indexes
    if (modelSchema.indexes) {
      if (!(modelSchema.indexes instanceof Array)) {
        throw new Error('indexes must be an array of field name strings');
      }

      for (var l = 0; l < modelSchema.indexes.length; l++) {
        if (typeof modelSchema.indexes[l] !== 'string') {
          throw new Error('indexes must be an array of strings');
        }

        var indexNameList = modelSchema.indexes[l].replace(/["\s]/g, '').split(/[()]/g);
        if (indexNameList.length > 1) {
          indexNameList[0] = indexNameList[0].toLowerCase();
          if (['entries', 'keys', 'values', 'full'].indexOf(indexNameList[0]) < 0) {
            throw new Error(util.format('index "%s" is not defined properly', modelSchema.indexes[l]));
          }
          if (!(indexNameList[1] in modelSchema.fields)) {
            throw new Error(util.format('"%s" is not a valid field name, indexes must be defined on field names', indexNameList[1]));
          }
          if (modelSchema.fields[indexNameList[1]].virtual) {
            throw new Error("indexes must be an array of db field names, can't contain virtual fields");
          }
        } else {
          if (!(indexNameList[0] in modelSchema.fields)) {
            throw new Error(util.format('"%s" is not a valid field, indexes must be defined on field names', indexNameList[0]));
          }
          if (modelSchema.fields[indexNameList[0]].virtual) {
            throw new Error("indexes must be an array of db field names, can't contain virtual fields");
          }
        }
      }
    }

    var validateCustomIndex = function validateCustomIndex(customIndex) {
      if (!_.isPlainObject(customIndex)) {
        throw new Error('custom_index must be an object with proper indexing attributes');
      }
      if (typeof customIndex.on !== 'string' || !(customIndex.on in modelSchema.fields)) {
        throw new Error("custom_index must have an 'on' attribute with string value and value must be a valid field name");
      }
      if (modelSchema.fields[customIndex.on].virtual) {
        throw new Error("custom_index 'on' attribute must be a db field name, can't contain virtual fields");
      }
      if (typeof customIndex.using !== 'string') {
        throw new Error("custom_index must have a 'using' attribute with string value");
      }
      if (!_.isPlainObject(customIndex.options)) {
        throw new Error('custom_index must have an "options" attribute and it must be an object, ' + 'pass blank {} object if no options are required');
      }
    };

    if (modelSchema.custom_index && modelSchema.custom_indexes) {
      throw new Error('both custom_index and custom_indexes are defined in schema, only one of them should be defined');
    }

    if (modelSchema.custom_index) {
      validateCustomIndex(modelSchema.custom_index);
    }

    if (modelSchema.custom_indexes) {
      if (modelSchema.custom_indexes instanceof Array) {
        for (var ci = 0; ci < modelSchema.custom_indexes.length; ci++) {
          validateCustomIndex(modelSchema.custom_indexes[ci]);
        }
      } else {
        throw new Error('custom_indexes must be an array with objects with proper indexing attributes');
      }
    }
  },
  get_field_type: function get_field_type(modelSchema, fieldname) {
    var fieldob = modelSchema.fields[fieldname];

    if (typeof fieldob === 'string') return fieldob;else if (_.isPlainObject(fieldob)) return fieldob.type;
    throw new Error(util.format('Field type not defined for field "%s"', fieldname));
  },
  is_field_default_value_valid: function is_field_default_value_valid(modelSchema, fieldname) {
    if (_.isPlainObject(modelSchema.fields[fieldname]) && modelSchema.fields[fieldname].default) {
      if (_.isPlainObject(modelSchema.fields[fieldname].default) && !modelSchema.fields[fieldname].default.$db_function) {
        if (['map', 'list', 'set', 'frozen'].indexOf(modelSchema.fields[fieldname].type) > -1) return true;
        return false;
      }
      return true;
    }
    return true;
  }
};

module.exports = schemer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9vcm0vYXBvbGxvX3NjaGVtZXIuanMiXSwibmFtZXMiOlsiVFlQRV9NQVAiLCJyZXF1aXJlIiwiXyIsInV0aWwiLCJzY2hlbWVyIiwibm9ybWFsaXplX21vZGVsX3NjaGVtYSIsIm1vZGVsU2NoZW1hIiwib3V0cHV0U2NoZW1hIiwiY2xvbmVEZWVwIiwiZ29vZEZpZWxkcyIsImZpZWxkcyIsImtleSIsImNsdXN0ZXJpbmdfb3JkZXIiLCJtYXRlcmlhbGl6ZWRfdmlld3MiLCJpbmRleGVzIiwiY3VzdG9tX2luZGV4IiwiY3VzdG9tX2luZGV4ZXMiLCJPYmplY3QiLCJrZXlzIiwiZm9yRWFjaCIsImsiLCJ0eXBlIiwidmlydHVhbCIsInR5cGVEZWYiLCJpbmRleE9mIiwidHlwZU1hcHMiLCJyZXBsYWNlIiwic3RhdGljTWFwcyIsInN0YXRpYyIsImxlbmd0aCIsImkiLCJ0b1VwcGVyQ2FzZSIsImFycmF5U29ydCIsImEiLCJiIiwibXZpbmRleCIsIm91dHB1dE1WaWV3IiwicGtleUluZGV4IiwicGFydGl0aW9uSW5kZXgiLCJzZWxlY3QiLCJwdXNoIiwic29ydCIsImluZGV4TmFtZUxpc3QiLCJzcGxpdCIsInRvTG93ZXJDYXNlIiwiZm9ybWF0IiwiY3VzdG9tQXJyYXlTb3J0Iiwib24iLCJ1c2luZyIsIm9wdGlvbnMiLCJ2YWxpZGF0ZV9tb2RlbF9zY2hlbWEiLCJFcnJvciIsImlzUGxhaW5PYmplY3QiLCJBcnJheSIsImZpZWxkdHlwZSIsImdldF9maWVsZF90eXBlIiwiaXNfZmllbGRfZGVmYXVsdF92YWx1ZV92YWxpZCIsImoiLCJjaW5kZXgiLCJjYW5kaWRhdGVNVmlldyIsInNlbGVjdGluZGV4IiwibCIsInZhbGlkYXRlQ3VzdG9tSW5kZXgiLCJjdXN0b21JbmRleCIsImNpIiwiZmllbGRuYW1lIiwiZmllbGRvYiIsImRlZmF1bHQiLCIkZGJfZnVuY3Rpb24iLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLElB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QixFQW9ldUM7QUFDbkQsUUFBSS9ELEVBQUVrRCxhQUFGLENBQWdCOUMsWUFBWUksTUFBWixDQUFtQnVELFNBQW5CLENBQWhCLEtBQWtEM0QsWUFBWUksTUFBWixDQUFtQnVELFNBQW5CLEVBQThCRSxPQUFwRixFQUE2RjtBQUMzRixVQUFJakUsRUFBRWtELGFBQUYsQ0FBZ0I5QyxZQUFZSSxNQUFaLENBQW1CdUQsU0FBbkIsRUFBOEJFLE9BQTlDLEtBQ0csQ0FBRTdELFlBQVlJLE1BQVosQ0FBbUJ1RCxTQUFuQixFQUE4QkUsT0FBOUIsQ0FBc0NDLFlBRC9DLEVBQzhEO0FBQzVELFlBQUksQ0FBQyxLQUFELEVBQVEsTUFBUixFQUFnQixLQUFoQixFQUF1QixRQUF2QixFQUFpQzVDLE9BQWpDLENBQXlDbEIsWUFBWUksTUFBWixDQUFtQnVELFNBQW5CLEVBQThCNUMsSUFBdkUsSUFBK0UsQ0FBQyxDQUFwRixFQUF1RixPQUFPLElBQVA7QUFDdkYsZUFBTyxLQUFQO0FBQ0Q7QUFDRCxhQUFPLElBQVA7QUFDRDtBQUNELFdBQU8sSUFBUDtBQUNEO0FBOWVhLENBQWhCOztBQWtmQWdELE9BQU9DLE9BQVAsR0FBaUJsRSxPQUFqQiIsImZpbGUiOiJhcG9sbG9fc2NoZW1lci5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IFRZUEVfTUFQID0gcmVxdWlyZSgnLi9jYXNzYW5kcmFfdHlwZXMnKTtcbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbmNvbnN0IHV0aWwgPSByZXF1aXJlKCd1dGlsJyk7XG5cbmNvbnN0IHNjaGVtZXIgPSB7XG5cbiAgbm9ybWFsaXplX21vZGVsX3NjaGVtYShtb2RlbFNjaGVtYSkge1xuICAgIGNvbnN0IG91dHB1dFNjaGVtYSA9IF8uY2xvbmVEZWVwKG1vZGVsU2NoZW1hLCB0cnVlKTtcbiAgICBjb25zdCBnb29kRmllbGRzID0ge1xuICAgICAgZmllbGRzOiB0cnVlLFxuICAgICAga2V5OiB0cnVlLFxuICAgICAgY2x1c3RlcmluZ19vcmRlcjogdHJ1ZSxcbiAgICAgIG1hdGVyaWFsaXplZF92aWV3czogdHJ1ZSxcbiAgICAgIGluZGV4ZXM6IHRydWUsXG4gICAgICBjdXN0b21faW5kZXg6IHRydWUsXG4gICAgICBjdXN0b21faW5kZXhlczogdHJ1ZSxcbiAgICB9O1xuXG4gICAgT2JqZWN0LmtleXMob3V0cHV0U2NoZW1hKS5mb3JFYWNoKChrKSA9PiB7XG4gICAgICBpZiAoIShrIGluIGdvb2RGaWVsZHMpKSBkZWxldGUgKG91dHB1dFNjaGVtYVtrXSk7XG4gICAgfSk7XG5cbiAgICBPYmplY3Qua2V5cyhvdXRwdXRTY2hlbWEuZmllbGRzKS5mb3JFYWNoKChrKSA9PiB7XG4gICAgICBpZiAodHlwZW9mIChvdXRwdXRTY2hlbWEuZmllbGRzW2tdKSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgb3V0cHV0U2NoZW1hLmZpZWxkc1trXSA9IHsgdHlwZTogb3V0cHV0U2NoZW1hLmZpZWxkc1trXSB9O1xuICAgICAgfSBlbHNlIGlmIChvdXRwdXRTY2hlbWEuZmllbGRzW2tdKSB7XG4gICAgICAgIGlmIChvdXRwdXRTY2hlbWEuZmllbGRzW2tdLnZpcnR1YWwpIHtcbiAgICAgICAgICBkZWxldGUgb3V0cHV0U2NoZW1hLmZpZWxkc1trXTtcbiAgICAgICAgfSBlbHNlIGlmIChvdXRwdXRTY2hlbWEuZmllbGRzW2tdLnR5cGVEZWYpIHtcbiAgICAgICAgICBvdXRwdXRTY2hlbWEuZmllbGRzW2tdID0geyB0eXBlOiBvdXRwdXRTY2hlbWEuZmllbGRzW2tdLnR5cGUsIHR5cGVEZWY6IG91dHB1dFNjaGVtYS5maWVsZHNba10udHlwZURlZiB9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG91dHB1dFNjaGVtYS5maWVsZHNba10gPSB7IHR5cGU6IG91dHB1dFNjaGVtYS5maWVsZHNba10udHlwZSB9O1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyAoJ3NjaGVtYSBmaWVsZCBcIiVzXCIgaXMgbm90IHByb3Blcmx5IGRlZmluZWQ6ICVzJywgaywgb3V0cHV0U2NoZW1hLmZpZWxkc1trXSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChvdXRwdXRTY2hlbWEuZmllbGRzW2tdICYmIG91dHB1dFNjaGVtYS5maWVsZHNba10udHlwZSA9PT0gJ3ZhcmNoYXInKSB7XG4gICAgICAgIG91dHB1dFNjaGVtYS5maWVsZHNba10udHlwZSA9ICd0ZXh0JztcbiAgICAgIH1cblxuICAgICAgaWYgKG91dHB1dFNjaGVtYS5maWVsZHNba10gJiYgWydtYXAnLCAnbGlzdCcsICdzZXQnLCAnZnJvemVuJ10uaW5kZXhPZihvdXRwdXRTY2hlbWEuZmllbGRzW2tdLnR5cGUpID4gLTEpIHtcbiAgICAgICAgaWYgKG1vZGVsU2NoZW1hLnR5cGVNYXBzICYmIG1vZGVsU2NoZW1hLnR5cGVNYXBzW2tdKSB7XG4gICAgICAgICAgb3V0cHV0U2NoZW1hLmZpZWxkc1trXS50eXBlRGVmID0gbW9kZWxTY2hlbWEudHlwZU1hcHNba107XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG1heC1sZW5cbiAgICAgICAgICBvdXRwdXRTY2hlbWEuZmllbGRzW2tdLnR5cGVEZWYgPSBvdXRwdXRTY2hlbWEuZmllbGRzW2tdLnR5cGVEZWYucmVwbGFjZSgvW1xcc10vZywgJycpLnJlcGxhY2UoL3ZhcmNoYXIvZywgJ3RleHQnKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAobW9kZWxTY2hlbWEuc3RhdGljTWFwcyAmJiBtb2RlbFNjaGVtYS5zdGF0aWNNYXBzW2tdID09PSB0cnVlKSB7XG4gICAgICAgIG91dHB1dFNjaGVtYS5maWVsZHNba10uc3RhdGljID0gdHJ1ZTtcbiAgICAgIH0gZWxzZSBpZiAobW9kZWxTY2hlbWEuZmllbGRzW2tdLnN0YXRpYykge1xuICAgICAgICBvdXRwdXRTY2hlbWEuZmllbGRzW2tdLnN0YXRpYyA9IHRydWU7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBpZiAob3V0cHV0U2NoZW1hLmtleSAmJiB0eXBlb2Ygb3V0cHV0U2NoZW1hLmtleVswXSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIG91dHB1dFNjaGVtYS5rZXlbMF0gPSBbb3V0cHV0U2NoZW1hLmtleVswXV07XG4gICAgfVxuXG4gICAgaWYgKG91dHB1dFNjaGVtYS5rZXkgJiYgb3V0cHV0U2NoZW1hLmtleS5sZW5ndGgpIHtcbiAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgb3V0cHV0U2NoZW1hLmtleS5sZW5ndGg7IGkrKykge1xuICAgICAgICBpZiAoIW91dHB1dFNjaGVtYS5jbHVzdGVyaW5nX29yZGVyKSBvdXRwdXRTY2hlbWEuY2x1c3RlcmluZ19vcmRlciA9IHt9O1xuICAgICAgICBpZiAoIW91dHB1dFNjaGVtYS5jbHVzdGVyaW5nX29yZGVyW291dHB1dFNjaGVtYS5rZXlbaV1dKSB7XG4gICAgICAgICAgb3V0cHV0U2NoZW1hLmNsdXN0ZXJpbmdfb3JkZXJbb3V0cHV0U2NoZW1hLmtleVtpXV0gPSAnQVNDJztcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBtYXgtbGVuXG4gICAgICAgIG91dHB1dFNjaGVtYS5jbHVzdGVyaW5nX29yZGVyW291dHB1dFNjaGVtYS5rZXlbaV1dID0gb3V0cHV0U2NoZW1hLmNsdXN0ZXJpbmdfb3JkZXJbb3V0cHV0U2NoZW1hLmtleVtpXV0udG9VcHBlckNhc2UoKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBhcnJheVNvcnQgPSAoYSwgYikgPT4ge1xuICAgICAgaWYgKGEgPiBiKSByZXR1cm4gMTtcbiAgICAgIGlmIChhIDwgYikgcmV0dXJuIC0xO1xuICAgICAgcmV0dXJuIDA7XG4gICAgfTtcblxuICAgIGlmIChvdXRwdXRTY2hlbWEubWF0ZXJpYWxpemVkX3ZpZXdzKSB7XG4gICAgICBPYmplY3Qua2V5cyhvdXRwdXRTY2hlbWEubWF0ZXJpYWxpemVkX3ZpZXdzKS5mb3JFYWNoKChtdmluZGV4KSA9PiB7XG4gICAgICAgIGNvbnN0IG91dHB1dE1WaWV3ID0gb3V0cHV0U2NoZW1hLm1hdGVyaWFsaXplZF92aWV3c1ttdmluZGV4XTtcbiAgICAgICAgLy8gbWFrZSBwYXJpdGlvbiBrZXkgYW4gYXJyYXlcbiAgICAgICAgaWYgKG91dHB1dE1WaWV3LmtleVxuICAgICAgICAgICAgICAmJiB0eXBlb2Ygb3V0cHV0TVZpZXcua2V5WzBdID09PSAnc3RyaW5nJykge1xuICAgICAgICAgIG91dHB1dE1WaWV3LmtleVswXSA9IFtvdXRwdXRNVmlldy5rZXlbMF1dO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gYWRkIGNsdXN0ZXJpbmdfb3JkZXIgZm9yIGFsbCBjbHVzdGVyaW5nIGtleXNcbiAgICAgICAgaWYgKG91dHB1dE1WaWV3LmtleVxuICAgICAgICAgICAgICAmJiBvdXRwdXRNVmlldy5rZXkubGVuZ3RoKSB7XG4gICAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBvdXRwdXRNVmlldy5rZXkubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGlmICghb3V0cHV0TVZpZXcuY2x1c3RlcmluZ19vcmRlcikge1xuICAgICAgICAgICAgICBvdXRwdXRNVmlldy5jbHVzdGVyaW5nX29yZGVyID0ge307XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIW91dHB1dE1WaWV3LmNsdXN0ZXJpbmdfb3JkZXJbb3V0cHV0TVZpZXcua2V5W2ldXSkge1xuICAgICAgICAgICAgICBvdXRwdXRNVmlldy5jbHVzdGVyaW5nX29yZGVyW291dHB1dE1WaWV3LmtleVtpXV0gPSAnQVNDJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBtYXgtbGVuXG4gICAgICAgICAgICBvdXRwdXRNVmlldy5jbHVzdGVyaW5nX29yZGVyW291dHB1dE1WaWV3LmtleVtpXV0gPSBvdXRwdXRNVmlldy5jbHVzdGVyaW5nX29yZGVyW291dHB1dE1WaWV3LmtleVtpXV0udG9VcHBlckNhc2UoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBhZGQgYWxsIG5vbiBleGlzdGVudCBwcmltYXJ5IGtleSBpdGVtcyB0byBzZWxlY3QgYW5kIHNvcnQgdGhlbVxuICAgICAgICBmb3IgKGxldCBwa2V5SW5kZXggPSAwOyBwa2V5SW5kZXggPCBvdXRwdXRNVmlldy5rZXkubGVuZ3RoOyBwa2V5SW5kZXgrKykge1xuICAgICAgICAgIGlmIChwa2V5SW5kZXggPT09IDApIHtcbiAgICAgICAgICAgIGZvciAobGV0IHBhcnRpdGlvbkluZGV4ID0gMDsgcGFydGl0aW9uSW5kZXggPCBvdXRwdXRNVmlldy5rZXlbcGtleUluZGV4XS5sZW5ndGg7IHBhcnRpdGlvbkluZGV4KyspIHtcbiAgICAgICAgICAgICAgaWYgKG91dHB1dE1WaWV3LnNlbGVjdC5pbmRleE9mKG91dHB1dE1WaWV3LmtleVtwa2V5SW5kZXhdW3BhcnRpdGlvbkluZGV4XSkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgb3V0cHV0TVZpZXcuc2VsZWN0LnB1c2gob3V0cHV0TVZpZXcua2V5W3BrZXlJbmRleF1bcGFydGl0aW9uSW5kZXhdKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSBpZiAob3V0cHV0TVZpZXcuc2VsZWN0LmluZGV4T2Yob3V0cHV0TVZpZXcua2V5W3BrZXlJbmRleF0pID09PSAtMSkge1xuICAgICAgICAgICAgb3V0cHV0TVZpZXcuc2VsZWN0LnB1c2gob3V0cHV0TVZpZXcua2V5W3BrZXlJbmRleF0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGNoZWNrIGlmIHNlbGVjdCBoYXMgKiBhbmQgdGhlbiBhZGQgYWxsIGZpZWxkcyB0byBzZWxlY3RcbiAgICAgICAgaWYgKG91dHB1dE1WaWV3LnNlbGVjdFswXSA9PT0gJyonKSB7XG4gICAgICAgICAgb3V0cHV0TVZpZXcuc2VsZWN0ID0gT2JqZWN0LmtleXMob3V0cHV0U2NoZW1hLmZpZWxkcyk7XG4gICAgICAgIH1cblxuICAgICAgICBvdXRwdXRNVmlldy5zZWxlY3Quc29ydChhcnJheVNvcnQpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIG91dHB1dFNjaGVtYS5tYXRlcmlhbGl6ZWRfdmlld3MgPSB7fTtcbiAgICB9XG5cbiAgICBpZiAob3V0cHV0U2NoZW1hLmluZGV4ZXMpIHtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb3V0cHV0U2NoZW1hLmluZGV4ZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3QgaW5kZXhOYW1lTGlzdCA9IG91dHB1dFNjaGVtYS5pbmRleGVzW2ldLnJlcGxhY2UoL1tcIlxcc10vZywgJycpLnNwbGl0KC9bKCldL2cpO1xuICAgICAgICBpZiAoaW5kZXhOYW1lTGlzdC5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgaW5kZXhOYW1lTGlzdFswXSA9IGluZGV4TmFtZUxpc3RbMF0udG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICBpZiAoaW5kZXhOYW1lTGlzdFswXSA9PT0gJ3ZhbHVlcycpIG91dHB1dFNjaGVtYS5pbmRleGVzW2ldID0gaW5kZXhOYW1lTGlzdFsxXTtcbiAgICAgICAgICBlbHNlIG91dHB1dFNjaGVtYS5pbmRleGVzW2ldID0gdXRpbC5mb3JtYXQoJyVzKCVzKScsIGluZGV4TmFtZUxpc3RbMF0sIGluZGV4TmFtZUxpc3RbMV0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG91dHB1dFNjaGVtYS5pbmRleGVzW2ldID0gaW5kZXhOYW1lTGlzdFswXTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgb3V0cHV0U2NoZW1hLmluZGV4ZXMuc29ydChhcnJheVNvcnQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBvdXRwdXRTY2hlbWEuaW5kZXhlcyA9IFtdO1xuICAgIH1cblxuICAgIGlmIChvdXRwdXRTY2hlbWEuY3VzdG9tX2luZGV4KSB7XG4gICAgICBvdXRwdXRTY2hlbWEuY3VzdG9tX2luZGV4ZXMgPSBbb3V0cHV0U2NoZW1hLmN1c3RvbV9pbmRleF07XG4gICAgICBkZWxldGUgb3V0cHV0U2NoZW1hLmN1c3RvbV9pbmRleDtcbiAgICB9XG5cbiAgICBpZiAob3V0cHV0U2NoZW1hLmN1c3RvbV9pbmRleGVzKSB7XG4gICAgICBjb25zdCBjdXN0b21BcnJheVNvcnQgPSAoYSwgYikgPT4ge1xuICAgICAgICBpZiAoYS5vbiA+IGIub24pIHJldHVybiAxO1xuICAgICAgICBpZiAoYS5vbiA8IGIub24pIHJldHVybiAtMTtcblxuICAgICAgICBpZiAoYS51c2luZyA+IGIudXNpbmcpIHJldHVybiAxO1xuICAgICAgICBpZiAoYS51c2luZyA8IGIudXNpbmcpIHJldHVybiAtMTtcblxuICAgICAgICBpZiAoYS5vcHRpb25zID4gYi5vcHRpb25zKSByZXR1cm4gMTtcbiAgICAgICAgaWYgKGEub3B0aW9ucyA8IGIub3B0aW9ucykgcmV0dXJuIC0xO1xuXG4gICAgICAgIHJldHVybiAwO1xuICAgICAgfTtcblxuICAgICAgb3V0cHV0U2NoZW1hLmN1c3RvbV9pbmRleGVzLnNvcnQoY3VzdG9tQXJyYXlTb3J0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgb3V0cHV0U2NoZW1hLmN1c3RvbV9pbmRleGVzID0gW107XG4gICAgfVxuXG4gICAgcmV0dXJuIG91dHB1dFNjaGVtYTtcbiAgfSxcblxuICB2YWxpZGF0ZV9tb2RlbF9zY2hlbWEobW9kZWxTY2hlbWEpIHtcbiAgICBpZiAoIW1vZGVsU2NoZW1hKSB0aHJvdyAobmV3IEVycm9yKCdBIHNjaGVtYSBtdXN0IGJlIHNwZWNpZmllZCcpKTtcblxuICAgIGlmICghXy5pc1BsYWluT2JqZWN0KG1vZGVsU2NoZW1hLmZpZWxkcykgfHwgT2JqZWN0LmtleXMobW9kZWxTY2hlbWEuZmllbGRzKS5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IChuZXcgRXJyb3IoJ1NjaGVtYSBtdXN0IGNvbnRhaW4gYSBub24tZW1wdHkgXCJmaWVsZHNcIiBtYXAgb2JqZWN0JykpO1xuICAgIH1cblxuICAgIGlmICghbW9kZWxTY2hlbWEua2V5IHx8ICEobW9kZWxTY2hlbWEua2V5IGluc3RhbmNlb2YgQXJyYXkpKSB7XG4gICAgICB0aHJvdyAobmV3IEVycm9yKCdTY2hlbWEgbXVzdCBjb250YWluIFwia2V5XCIgaW4gdGhlIGZvcm06IFsgW3BhcnRpdGlvbmtleTEsIC4uLl0sIGNsdXN0ZXJpbmdrZXkxLCAuLi5dJykpO1xuICAgIH1cblxuICAgIE9iamVjdC5rZXlzKG1vZGVsU2NoZW1hLmZpZWxkcykuZm9yRWFjaCgoaykgPT4ge1xuICAgICAgY29uc3QgZmllbGR0eXBlID0gdGhpcy5nZXRfZmllbGRfdHlwZShtb2RlbFNjaGVtYSwgayk7XG4gICAgICBpZiAoIShmaWVsZHR5cGUgaW4gVFlQRV9NQVApKSB7XG4gICAgICAgIHRocm93IChuZXcgRXJyb3IoXG4gICAgICAgICAgdXRpbC5mb3JtYXQoJ0dpdmVuIHNjaGVtYSBmaWVsZCB0eXBlIGlzIG5vdCBzdXBwb3J0ZWQgZm9yOiAlcyglcyknLCBrLCBtb2RlbFNjaGVtYS5maWVsZHNba10udHlwZSlcbiAgICAgICAgKSk7XG4gICAgICB9XG4gICAgICBpZiAoISh0aGlzLmlzX2ZpZWxkX2RlZmF1bHRfdmFsdWVfdmFsaWQobW9kZWxTY2hlbWEsIGspKSkge1xuICAgICAgICB0aHJvdyAobmV3IEVycm9yKFxuICAgICAgICAgIHV0aWwuZm9ybWF0KCdJbnZhbGlkIGRlZnVsdCBkZWZpbml0aW9uIGZvcjogJXMoJXMpJywgaywgbW9kZWxTY2hlbWEuZmllbGRzW2tdLnR5cGUpXG4gICAgICAgICkpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gdmFsaWRhdGUgcHJpbWFyeSBrZXlcbiAgICBpZiAodHlwZW9mIChtb2RlbFNjaGVtYS5rZXlbMF0pID09PSAnc3RyaW5nJykge1xuICAgICAgaWYgKCEobW9kZWxTY2hlbWEua2V5WzBdIGluIG1vZGVsU2NoZW1hLmZpZWxkcykpIHtcbiAgICAgICAgdGhyb3cgKG5ldyBFcnJvcignUGFydGl0aW9uIEtleSBtdXN0IGFsc28gYmUgYSB2YWxpZCBmaWVsZCBuYW1lJykpO1xuICAgICAgfVxuICAgICAgaWYgKG1vZGVsU2NoZW1hLmZpZWxkc1ttb2RlbFNjaGVtYS5rZXlbMF1dLnZpcnR1YWwpIHtcbiAgICAgICAgdGhyb3cgKG5ldyBFcnJvcihcIlBhcnRpdGlvbiBLZXkgbXVzdCBhbHNvIGJlIGEgZGIgZmllbGQgbmFtZSwgY2FuJ3QgYmUgYSB2aXJ0dWFsIGZpZWxkIG5hbWVcIikpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAobW9kZWxTY2hlbWEua2V5WzBdIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgIGlmIChtb2RlbFNjaGVtYS5rZXlbMF0ubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRocm93IChuZXcgRXJyb3IoXCJQYXJ0aXRpb24gS2V5IGFycmF5IGNhbid0IGJlIGVtcHR5XCIpKTtcbiAgICAgIH1cbiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbW9kZWxTY2hlbWEua2V5WzBdLmxlbmd0aDsgaisrKSB7XG4gICAgICAgIGlmICgodHlwZW9mIChtb2RlbFNjaGVtYS5rZXlbMF1bal0pICE9PSAnc3RyaW5nJykgfHwgIShtb2RlbFNjaGVtYS5rZXlbMF1bal0gaW4gbW9kZWxTY2hlbWEuZmllbGRzKSkge1xuICAgICAgICAgIHRocm93IChuZXcgRXJyb3IoJ1BhcnRpdGlvbiBLZXkgYXJyYXkgbXVzdCBjb250YWluIG9ubHkgdmFsaWQgZmllbGQgbmFtZXMnKSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1vZGVsU2NoZW1hLmZpZWxkc1ttb2RlbFNjaGVtYS5rZXlbMF1bal1dLnZpcnR1YWwpIHtcbiAgICAgICAgICB0aHJvdyAobmV3IEVycm9yKFxuICAgICAgICAgICAgXCJQYXJ0aXRpb24gS2V5IGFycmF5IG11c3QgY29udGFpbiBvbmx5IGRiIGZpZWxkIG5hbWVzLCBjYW4ndCBjb250YWluIHZpcnR1YWwgZmllbGQgbmFtZXNcIlxuICAgICAgICAgICkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IChuZXcgRXJyb3IoJ1BhcnRpdGlvbiBLZXkgbXVzdCBiZSBhIGZpZWxkIG5hbWUgc3RyaW5nLCBvciBhcnJheSBvZiBmaWVsZCBuYW1lcycpKTtcbiAgICB9XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1vZGVsU2NoZW1hLmtleS5sZW5ndGg7IGkrKykge1xuICAgICAgaWYgKGkgPiAwKSB7XG4gICAgICAgIGlmICgodHlwZW9mIChtb2RlbFNjaGVtYS5rZXlbaV0pICE9PSAnc3RyaW5nJykgfHwgIShtb2RlbFNjaGVtYS5rZXlbaV0gaW4gbW9kZWxTY2hlbWEuZmllbGRzKSkge1xuICAgICAgICAgIHRocm93IChuZXcgRXJyb3IoJ0NsdXN0ZXJpbmcgS2V5cyBtdXN0IGJlIHZhbGlkIGZpZWxkIG5hbWVzJykpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChtb2RlbFNjaGVtYS5maWVsZHNbbW9kZWxTY2hlbWEua2V5W2ldXS52aXJ0dWFsKSB7XG4gICAgICAgICAgdGhyb3cgKG5ldyBFcnJvcihcbiAgICAgICAgICAgIFwiQ2x1c3RlcmluZyBLZXlzIG11c3QgYmUgZGIgZmllbGQgbmFtZXMsIGNhbid0IGJlIHZpcnR1YWwgZmllbGQgbmFtZXNcIlxuICAgICAgICAgICkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKG1vZGVsU2NoZW1hLmNsdXN0ZXJpbmdfb3JkZXIpIHtcbiAgICAgIGlmICghXy5pc1BsYWluT2JqZWN0KG1vZGVsU2NoZW1hLmNsdXN0ZXJpbmdfb3JkZXIpKSB7XG4gICAgICAgIHRocm93IChuZXcgRXJyb3IoJ2NsdXN0ZXJpbmdfb3JkZXIgbXVzdCBiZSBhbiBvYmplY3Qgb2YgY2x1c3RlcmluZ19rZXkgYXR0cmlidXRlcycpKTtcbiAgICAgIH1cblxuICAgICAgT2JqZWN0LmtleXMobW9kZWxTY2hlbWEuY2x1c3RlcmluZ19vcmRlcikuZm9yRWFjaCgoY2luZGV4KSA9PiB7XG4gICAgICAgIGlmIChbJ2FzYycsICdkZXNjJ10uaW5kZXhPZihtb2RlbFNjaGVtYS5jbHVzdGVyaW5nX29yZGVyW2NpbmRleF0udG9Mb3dlckNhc2UoKSkgPT09IC0xKSB7XG4gICAgICAgICAgdGhyb3cgKG5ldyBFcnJvcignY2x1c3RlcmluZ19vcmRlciBhdHRyaWJ1dGUgdmFsdWVzIGNhbiBvbmx5IGJlIEFTQyBvciBERVNDJykpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChtb2RlbFNjaGVtYS5rZXkuaW5kZXhPZihjaW5kZXgpIDwgMSkge1xuICAgICAgICAgIHRocm93IChuZXcgRXJyb3IoJ2NsdXN0ZXJpbmdfb3JkZXIgZmllbGQgYXR0cmlidXRlcyBtdXN0IGJlIGNsdXN0ZXJpbmcga2V5cyBvbmx5JykpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyB2YWxpZGF0ZSBtYXRlcmlhbGl6ZWRfdmlld1xuICAgIGlmIChtb2RlbFNjaGVtYS5tYXRlcmlhbGl6ZWRfdmlld3MpIHtcbiAgICAgIGlmICghXy5pc1BsYWluT2JqZWN0KG1vZGVsU2NoZW1hLm1hdGVyaWFsaXplZF92aWV3cykpIHtcbiAgICAgICAgdGhyb3cgKG5ldyBFcnJvcignbWF0ZXJpYWxpemVkX3ZpZXdzIG11c3QgYmUgYW4gb2JqZWN0IHdpdGggdmlldyBuYW1lcyBhcyBhdHRyaWJ1dGVzJykpO1xuICAgICAgfVxuXG4gICAgICBPYmplY3Qua2V5cyhtb2RlbFNjaGVtYS5tYXRlcmlhbGl6ZWRfdmlld3MpLmZvckVhY2goKG12aW5kZXgpID0+IHtcbiAgICAgICAgY29uc3QgY2FuZGlkYXRlTVZpZXcgPSBtb2RlbFNjaGVtYS5tYXRlcmlhbGl6ZWRfdmlld3NbbXZpbmRleF07XG4gICAgICAgIGlmICghXy5pc1BsYWluT2JqZWN0KGNhbmRpZGF0ZU1WaWV3KSkge1xuICAgICAgICAgIHRocm93IChuZXcgRXJyb3IoXG4gICAgICAgICAgICB1dGlsLmZvcm1hdCgnYXR0cmlidXRlIFwiJXNcIiB1bmRlciBtYXRlcmlhbGl6ZWRfdmlld3MgbXVzdCBiZSBhbiBvYmplY3QnLCBtdmluZGV4KVxuICAgICAgICAgICkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFjYW5kaWRhdGVNVmlldy5zZWxlY3QgfHwgIWNhbmRpZGF0ZU1WaWV3LmtleSkge1xuICAgICAgICAgIHRocm93IChuZXcgRXJyb3IoXG4gICAgICAgICAgICB1dGlsLmZvcm1hdCgnbWF0ZXJpYWxpemVkX3ZpZXcgXCIlc1wiIG11c3QgaGF2ZSBcInNlbGVjdFwiIGFuZCBcImtleVwiIGF0dHJpYnV0ZXMnLCBtdmluZGV4KVxuICAgICAgICAgICkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCEoY2FuZGlkYXRlTVZpZXcuc2VsZWN0IGluc3RhbmNlb2YgQXJyYXkpIHx8ICEoY2FuZGlkYXRlTVZpZXcua2V5IGluc3RhbmNlb2YgQXJyYXkpKSB7XG4gICAgICAgICAgdGhyb3cgKCdcInNlbGVjdFwiIGFuZCBcImtleVwiIGF0dHJpYnV0ZXMgbXVzdCBiZSBhbiBhcnJheSB1bmRlciBhdHRyaWJ1dGUgJXMgb2YgbWF0ZXJpYWxpemVkX3ZpZXdzJywgbXZpbmRleCk7XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGxldCBzZWxlY3RpbmRleCA9IDA7IHNlbGVjdGluZGV4IDwgY2FuZGlkYXRlTVZpZXcuc2VsZWN0Lmxlbmd0aDsgc2VsZWN0aW5kZXgrKykge1xuICAgICAgICAgIGlmICgodHlwZW9mIChjYW5kaWRhdGVNVmlldy5zZWxlY3Rbc2VsZWN0aW5kZXhdKSAhPT0gJ3N0cmluZycpXG4gICAgICAgICAgICAgICAgfHwgIShjYW5kaWRhdGVNVmlldy5zZWxlY3Rbc2VsZWN0aW5kZXhdIGluIG1vZGVsU2NoZW1hLmZpZWxkc1xuICAgICAgICAgICAgICAgIHx8IGNhbmRpZGF0ZU1WaWV3LnNlbGVjdFtzZWxlY3RpbmRleF0gPT09ICcqJykpIHtcbiAgICAgICAgICAgIHRocm93IChuZXcgRXJyb3IoXG4gICAgICAgICAgICAgIHV0aWwuZm9ybWF0KFxuICAgICAgICAgICAgICAgICd0aGUgc2VsZWN0IGF0dHJpYnV0ZSB1bmRlciBtYXRlcmlhbGl6ZWRfdmlldyAlcyBtdXN0IGJlIGFuIGFycmF5IG9mIGZpZWxkIG5hbWUgc3RyaW5ncyBvciBbXCIqXCJdJyxcbiAgICAgICAgICAgICAgICBtdmluZGV4XG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgICkpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmIChtb2RlbFNjaGVtYS5maWVsZHNbY2FuZGlkYXRlTVZpZXcuc2VsZWN0W3NlbGVjdGluZGV4XV1cbiAgICAgICAgICAgICAgJiYgbW9kZWxTY2hlbWEuZmllbGRzW2NhbmRpZGF0ZU1WaWV3LnNlbGVjdFtzZWxlY3RpbmRleF1dLnZpcnR1YWwpIHtcbiAgICAgICAgICAgIHRocm93IChuZXcgRXJyb3IoXG4gICAgICAgICAgICAgIHV0aWwuZm9ybWF0KFxuICAgICAgICAgICAgICAgICd0aGUgc2VsZWN0IGF0dHJpYnV0ZSB1bmRlciAlcyBvZiBtYXRlcmlhbGl6ZWRfdmlld3MgbXVzdCBiZSBhbiBhcnJheSBvZiBkYiBmaWVsZCBuYW1lcywgJyArXG4gICAgICAgICAgICAgICAgJ2Nhbm5vdCBjb250YWluIGFueSB2aXJ0dWFsIGZpZWxkIG5hbWUnLFxuICAgICAgICAgICAgICAgIG12aW5kZXhcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gdmFsaWRhdGUgbWF0ZXJpYWxpemVkX3ZpZXcgcHJpbWFyeSBrZXlcbiAgICAgICAgaWYgKHR5cGVvZiAoY2FuZGlkYXRlTVZpZXcua2V5WzBdKSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICBpZiAoIShjYW5kaWRhdGVNVmlldy5rZXlbMF0gaW4gbW9kZWxTY2hlbWEuZmllbGRzKSkge1xuICAgICAgICAgICAgdGhyb3cgKG5ldyBFcnJvcihcbiAgICAgICAgICAgICAgdXRpbC5mb3JtYXQoJ21hdGVyaWFsaXplZF92aWV3ICVzOiBwYXJ0aXRpb24ga2V5IHN0cmluZyBtdXN0IG1hdGNoIGEgdmFsaWQgZmllbGQgbmFtZScsIG12aW5kZXgpXG4gICAgICAgICAgICApKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKG1vZGVsU2NoZW1hLmZpZWxkc1tjYW5kaWRhdGVNVmlldy5rZXlbMF1dLnZpcnR1YWwpIHtcbiAgICAgICAgICAgIHRocm93IChuZXcgRXJyb3IoXG4gICAgICAgICAgICAgIHV0aWwuZm9ybWF0KFxuICAgICAgICAgICAgICAgICdtYXRlcmlhbGl6ZWRfdmlldyAlczogcGFydGl0aW9uIGtleSBtdXN0IG1hdGNoIGEgZGIgZmllbGQgbmFtZSwgY2Fubm90IGJlIGEgdmlydHVhbCBmaWVsZCBuYW1lJyxcbiAgICAgICAgICAgICAgICBtdmluZGV4XG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgICkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChjYW5kaWRhdGVNVmlldy5rZXlbMF0gaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICAgIGlmIChjYW5kaWRhdGVNVmlldy5rZXlbMF0ubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICB0aHJvdyAobmV3IEVycm9yKFxuICAgICAgICAgICAgICB1dGlsLmZvcm1hdCgnbWF0ZXJpYWxpemVkX3ZpZXcgJXM6IHBhcnRpdGlvbiBrZXkgYXJyYXkgY2Fubm90IGJlIGVtcHR5JywgbXZpbmRleClcbiAgICAgICAgICAgICkpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGNhbmRpZGF0ZU1WaWV3LmtleVswXS5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgaWYgKCh0eXBlb2YgKGNhbmRpZGF0ZU1WaWV3LmtleVswXVtqXSkgIT09ICdzdHJpbmcnKSB8fCAhKGNhbmRpZGF0ZU1WaWV3LmtleVswXVtqXSBpbiBtb2RlbFNjaGVtYS5maWVsZHMpKSB7XG4gICAgICAgICAgICAgIHRocm93IChuZXcgRXJyb3IoXG4gICAgICAgICAgICAgICAgdXRpbC5mb3JtYXQoJ21hdGVyaWFsaXplZF92aWV3ICVzOiBwYXJ0aXRpb24ga2V5IGFycmF5IG11c3QgY29udGFpbiBvbmx5IHZhbGlkIGZpZWxkIG5hbWVzJywgbXZpbmRleClcbiAgICAgICAgICAgICAgKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAobW9kZWxTY2hlbWEuZmllbGRzW2NhbmRpZGF0ZU1WaWV3LmtleVswXVtqXV0udmlydHVhbCkge1xuICAgICAgICAgICAgICB0aHJvdyAobmV3IEVycm9yKFxuICAgICAgICAgICAgICAgIHV0aWwuZm9ybWF0KFxuICAgICAgICAgICAgICAgICAgJ21hdGVyaWFsaXplZF92aWV3ICVzOiBwYXJ0aXRpb24ga2V5IGFycmF5IG11c3QgY29udGFpbiBvbmx5IGRiIGZpZWxkIG5hbWVzLCAnICtcbiAgICAgICAgICAgICAgICAgICdjYW5ub3QgY29udGFpbiB2aXJ0dWFsIGZpZWxkIG5hbWVzJyxcbiAgICAgICAgICAgICAgICAgIG12aW5kZXhcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyAobmV3IEVycm9yKFxuICAgICAgICAgICAgdXRpbC5mb3JtYXQoXG4gICAgICAgICAgICAgICdtYXRlcmlhbGl6ZWRfdmlldyAlczogcGFydGl0aW9uIGtleSBtdXN0IGJlIGEgZmllbGQgbmFtZSBzdHJpbmcsIG9yIGFycmF5IG9mIGZpZWxkIG5hbWVzJyxcbiAgICAgICAgICAgICAgbXZpbmRleFxuICAgICAgICAgICAgKVxuICAgICAgICAgICkpO1xuICAgICAgICB9XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjYW5kaWRhdGVNVmlldy5rZXkubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBpZiAoaSA+IDApIHtcbiAgICAgICAgICAgIGlmICgodHlwZW9mIChjYW5kaWRhdGVNVmlldy5rZXlbaV0pICE9PSAnc3RyaW5nJykgfHwgIShjYW5kaWRhdGVNVmlldy5rZXlbaV0gaW4gbW9kZWxTY2hlbWEuZmllbGRzKSkge1xuICAgICAgICAgICAgICB0aHJvdyAobmV3IEVycm9yKFxuICAgICAgICAgICAgICAgIHV0aWwuZm9ybWF0KCdtYXRlcmlhbGl6ZWRfdmlldyAlczogY2x1c3RlcmluZyBrZXlzIG11c3QgYmUgdmFsaWQgZmllbGQgbmFtZXMnLCBtdmluZGV4KVxuICAgICAgICAgICAgICApKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChtb2RlbFNjaGVtYS5maWVsZHNbY2FuZGlkYXRlTVZpZXcua2V5W2ldXS52aXJ0dWFsKSB7XG4gICAgICAgICAgICAgIHRocm93IChuZXcgRXJyb3IoXG4gICAgICAgICAgICAgICAgdXRpbC5mb3JtYXQoXG4gICAgICAgICAgICAgICAgICAnbWF0ZXJpYWxpemVkX3ZpZXcgJXM6IGNsdXN0ZXJpbmcga2V5cyBtdXN0IGJlIGRiIGZpZWxkIG5hbWVzLCBjYW5ub3QgY29udGFpbiB2aXJ0dWFsIGZpZWxkcycsXG4gICAgICAgICAgICAgICAgICBtdmluZGV4XG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICApKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY2FuZGlkYXRlTVZpZXcuY2x1c3RlcmluZ19vcmRlcikge1xuICAgICAgICAgIGlmICghXy5pc1BsYWluT2JqZWN0KGNhbmRpZGF0ZU1WaWV3LmNsdXN0ZXJpbmdfb3JkZXIpKSB7XG4gICAgICAgICAgICB0aHJvdyAobmV3IEVycm9yKFxuICAgICAgICAgICAgICB1dGlsLmZvcm1hdChcbiAgICAgICAgICAgICAgICAnbWF0ZXJpYWxpemVkX3ZpZXcgJXM6IGNsdXN0ZXJpbmdfb3JkZXIgbXVzdCBiZSBhbiBvYmplY3Qgb2YgY2x1c3RlcmluZ19rZXkgYXR0cmlidXRlcycsXG4gICAgICAgICAgICAgICAgbXZpbmRleFxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICApKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBPYmplY3Qua2V5cyhjYW5kaWRhdGVNVmlldy5jbHVzdGVyaW5nX29yZGVyKS5mb3JFYWNoKChjaW5kZXgpID0+IHtcbiAgICAgICAgICAgIGlmIChbJ2FzYycsICdkZXNjJ10uaW5kZXhPZihjYW5kaWRhdGVNVmlldy5jbHVzdGVyaW5nX29yZGVyW2NpbmRleF0udG9Mb3dlckNhc2UoKSkgPT09IC0xKSB7XG4gICAgICAgICAgICAgIHRocm93IChuZXcgRXJyb3IoXG4gICAgICAgICAgICAgICAgdXRpbC5mb3JtYXQoJ21hdGVyaWFsaXplZF92aWV3ICVzOiBjbHVzdGVyaW5nX29yZGVyIGF0dHJpYnV0ZSB2YWx1ZXMgY2FuIG9ubHkgYmUgQVNDIG9yIERFU0MnLCBtdmluZGV4KVxuICAgICAgICAgICAgICApKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChjYW5kaWRhdGVNVmlldy5rZXkuaW5kZXhPZihjaW5kZXgpIDwgMSkge1xuICAgICAgICAgICAgICB0aHJvdyAobmV3IEVycm9yKFxuICAgICAgICAgICAgICAgIHV0aWwuZm9ybWF0KFxuICAgICAgICAgICAgICAgICAgJ21hdGVyaWFsaXplZF92aWV3ICVzOiBjbHVzdGVyaW5nX29yZGVyIGZpZWxkIGF0dHJpYnV0ZXMgbXVzdCBiZSBjbHVzdGVyaW5nIGtleXMgb25seScsXG4gICAgICAgICAgICAgICAgICBtdmluZGV4XG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICApKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gdmFsaWRhdGUgaW5kZXhlc1xuICAgIGlmIChtb2RlbFNjaGVtYS5pbmRleGVzKSB7XG4gICAgICBpZiAoIShtb2RlbFNjaGVtYS5pbmRleGVzIGluc3RhbmNlb2YgQXJyYXkpKSB7XG4gICAgICAgIHRocm93IChuZXcgRXJyb3IoJ2luZGV4ZXMgbXVzdCBiZSBhbiBhcnJheSBvZiBmaWVsZCBuYW1lIHN0cmluZ3MnKSk7XG4gICAgICB9XG5cbiAgICAgIGZvciAobGV0IGwgPSAwOyBsIDwgbW9kZWxTY2hlbWEuaW5kZXhlcy5sZW5ndGg7IGwrKykge1xuICAgICAgICBpZiAodHlwZW9mIG1vZGVsU2NoZW1hLmluZGV4ZXNbbF0gIT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgdGhyb3cgKG5ldyBFcnJvcignaW5kZXhlcyBtdXN0IGJlIGFuIGFycmF5IG9mIHN0cmluZ3MnKSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBpbmRleE5hbWVMaXN0ID0gbW9kZWxTY2hlbWEuaW5kZXhlc1tsXS5yZXBsYWNlKC9bXCJcXHNdL2csICcnKS5zcGxpdCgvWygpXS9nKTtcbiAgICAgICAgaWYgKGluZGV4TmFtZUxpc3QubGVuZ3RoID4gMSkge1xuICAgICAgICAgIGluZGV4TmFtZUxpc3RbMF0gPSBpbmRleE5hbWVMaXN0WzBdLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgaWYgKFsnZW50cmllcycsICdrZXlzJywgJ3ZhbHVlcycsICdmdWxsJ10uaW5kZXhPZihpbmRleE5hbWVMaXN0WzBdKSA8IDApIHtcbiAgICAgICAgICAgIHRocm93IChuZXcgRXJyb3IoXG4gICAgICAgICAgICAgIHV0aWwuZm9ybWF0KCdpbmRleCBcIiVzXCIgaXMgbm90IGRlZmluZWQgcHJvcGVybHknLCBtb2RlbFNjaGVtYS5pbmRleGVzW2xdKVxuICAgICAgICAgICAgKSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICghKGluZGV4TmFtZUxpc3RbMV0gaW4gbW9kZWxTY2hlbWEuZmllbGRzKSkge1xuICAgICAgICAgICAgdGhyb3cgKG5ldyBFcnJvcihcbiAgICAgICAgICAgICAgdXRpbC5mb3JtYXQoJ1wiJXNcIiBpcyBub3QgYSB2YWxpZCBmaWVsZCBuYW1lLCBpbmRleGVzIG11c3QgYmUgZGVmaW5lZCBvbiBmaWVsZCBuYW1lcycsIGluZGV4TmFtZUxpc3RbMV0pXG4gICAgICAgICAgICApKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKG1vZGVsU2NoZW1hLmZpZWxkc1tpbmRleE5hbWVMaXN0WzFdXS52aXJ0dWFsKSB7XG4gICAgICAgICAgICB0aHJvdyAobmV3IEVycm9yKFwiaW5kZXhlcyBtdXN0IGJlIGFuIGFycmF5IG9mIGRiIGZpZWxkIG5hbWVzLCBjYW4ndCBjb250YWluIHZpcnR1YWwgZmllbGRzXCIpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKCEoaW5kZXhOYW1lTGlzdFswXSBpbiBtb2RlbFNjaGVtYS5maWVsZHMpKSB7XG4gICAgICAgICAgICB0aHJvdyAobmV3IEVycm9yKFxuICAgICAgICAgICAgICB1dGlsLmZvcm1hdCgnXCIlc1wiIGlzIG5vdCBhIHZhbGlkIGZpZWxkLCBpbmRleGVzIG11c3QgYmUgZGVmaW5lZCBvbiBmaWVsZCBuYW1lcycsIGluZGV4TmFtZUxpc3RbMF0pXG4gICAgICAgICAgICApKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKG1vZGVsU2NoZW1hLmZpZWxkc1tpbmRleE5hbWVMaXN0WzBdXS52aXJ0dWFsKSB7XG4gICAgICAgICAgICB0aHJvdyAobmV3IEVycm9yKFwiaW5kZXhlcyBtdXN0IGJlIGFuIGFycmF5IG9mIGRiIGZpZWxkIG5hbWVzLCBjYW4ndCBjb250YWluIHZpcnR1YWwgZmllbGRzXCIpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCB2YWxpZGF0ZUN1c3RvbUluZGV4ID0gKGN1c3RvbUluZGV4KSA9PiB7XG4gICAgICBpZiAoIV8uaXNQbGFpbk9iamVjdChjdXN0b21JbmRleCkpIHtcbiAgICAgICAgdGhyb3cgKG5ldyBFcnJvcignY3VzdG9tX2luZGV4IG11c3QgYmUgYW4gb2JqZWN0IHdpdGggcHJvcGVyIGluZGV4aW5nIGF0dHJpYnV0ZXMnKSk7XG4gICAgICB9XG4gICAgICBpZiAoKHR5cGVvZiAoY3VzdG9tSW5kZXgub24pICE9PSAnc3RyaW5nJykgfHwgIShjdXN0b21JbmRleC5vbiBpbiBtb2RlbFNjaGVtYS5maWVsZHMpKSB7XG4gICAgICAgIHRocm93IChuZXcgRXJyb3IoXG4gICAgICAgICAgXCJjdXN0b21faW5kZXggbXVzdCBoYXZlIGFuICdvbicgYXR0cmlidXRlIHdpdGggc3RyaW5nIHZhbHVlIGFuZCB2YWx1ZSBtdXN0IGJlIGEgdmFsaWQgZmllbGQgbmFtZVwiXG4gICAgICAgICkpO1xuICAgICAgfVxuICAgICAgaWYgKG1vZGVsU2NoZW1hLmZpZWxkc1tjdXN0b21JbmRleC5vbl0udmlydHVhbCkge1xuICAgICAgICB0aHJvdyAobmV3IEVycm9yKFxuICAgICAgICAgIFwiY3VzdG9tX2luZGV4ICdvbicgYXR0cmlidXRlIG11c3QgYmUgYSBkYiBmaWVsZCBuYW1lLCBjYW4ndCBjb250YWluIHZpcnR1YWwgZmllbGRzXCJcbiAgICAgICAgKSk7XG4gICAgICB9XG4gICAgICBpZiAodHlwZW9mIChjdXN0b21JbmRleC51c2luZykgIT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHRocm93IChuZXcgRXJyb3IoXG4gICAgICAgICAgXCJjdXN0b21faW5kZXggbXVzdCBoYXZlIGEgJ3VzaW5nJyBhdHRyaWJ1dGUgd2l0aCBzdHJpbmcgdmFsdWVcIlxuICAgICAgICApKTtcbiAgICAgIH1cbiAgICAgIGlmICghXy5pc1BsYWluT2JqZWN0KGN1c3RvbUluZGV4Lm9wdGlvbnMpKSB7XG4gICAgICAgIHRocm93IChuZXcgRXJyb3IoXG4gICAgICAgICAgJ2N1c3RvbV9pbmRleCBtdXN0IGhhdmUgYW4gXCJvcHRpb25zXCIgYXR0cmlidXRlIGFuZCBpdCBtdXN0IGJlIGFuIG9iamVjdCwgJyArXG4gICAgICAgICAgJ3Bhc3MgYmxhbmsge30gb2JqZWN0IGlmIG5vIG9wdGlvbnMgYXJlIHJlcXVpcmVkJ1xuICAgICAgICApKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgaWYgKG1vZGVsU2NoZW1hLmN1c3RvbV9pbmRleCAmJiBtb2RlbFNjaGVtYS5jdXN0b21faW5kZXhlcykge1xuICAgICAgdGhyb3cgKG5ldyBFcnJvcihcbiAgICAgICAgJ2JvdGggY3VzdG9tX2luZGV4IGFuZCBjdXN0b21faW5kZXhlcyBhcmUgZGVmaW5lZCBpbiBzY2hlbWEsIG9ubHkgb25lIG9mIHRoZW0gc2hvdWxkIGJlIGRlZmluZWQnXG4gICAgICApKTtcbiAgICB9XG5cbiAgICBpZiAobW9kZWxTY2hlbWEuY3VzdG9tX2luZGV4KSB7XG4gICAgICB2YWxpZGF0ZUN1c3RvbUluZGV4KG1vZGVsU2NoZW1hLmN1c3RvbV9pbmRleCk7XG4gICAgfVxuXG4gICAgaWYgKG1vZGVsU2NoZW1hLmN1c3RvbV9pbmRleGVzKSB7XG4gICAgICBpZiAobW9kZWxTY2hlbWEuY3VzdG9tX2luZGV4ZXMgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICBmb3IgKGxldCBjaSA9IDA7IGNpIDwgbW9kZWxTY2hlbWEuY3VzdG9tX2luZGV4ZXMubGVuZ3RoOyBjaSsrKSB7XG4gICAgICAgICAgdmFsaWRhdGVDdXN0b21JbmRleChtb2RlbFNjaGVtYS5jdXN0b21faW5kZXhlc1tjaV0pO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyAobmV3IEVycm9yKFxuICAgICAgICAgICdjdXN0b21faW5kZXhlcyBtdXN0IGJlIGFuIGFycmF5IHdpdGggb2JqZWN0cyB3aXRoIHByb3BlciBpbmRleGluZyBhdHRyaWJ1dGVzJ1xuICAgICAgICApKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sXG5cbiAgZ2V0X2ZpZWxkX3R5cGUobW9kZWxTY2hlbWEsIGZpZWxkbmFtZSkge1xuICAgIGNvbnN0IGZpZWxkb2IgPSBtb2RlbFNjaGVtYS5maWVsZHNbZmllbGRuYW1lXTtcblxuICAgIGlmICh0eXBlb2YgZmllbGRvYiA9PT0gJ3N0cmluZycpIHJldHVybiBmaWVsZG9iO1xuICAgIGVsc2UgaWYgKF8uaXNQbGFpbk9iamVjdChmaWVsZG9iKSkgcmV0dXJuIGZpZWxkb2IudHlwZTtcbiAgICB0aHJvdyAobmV3IEVycm9yKHV0aWwuZm9ybWF0KCdGaWVsZCB0eXBlIG5vdCBkZWZpbmVkIGZvciBmaWVsZCBcIiVzXCInLCBmaWVsZG5hbWUpKSk7XG4gIH0sXG5cbiAgaXNfZmllbGRfZGVmYXVsdF92YWx1ZV92YWxpZChtb2RlbFNjaGVtYSwgZmllbGRuYW1lKSB7XG4gICAgaWYgKF8uaXNQbGFpbk9iamVjdChtb2RlbFNjaGVtYS5maWVsZHNbZmllbGRuYW1lXSkgJiYgbW9kZWxTY2hlbWEuZmllbGRzW2ZpZWxkbmFtZV0uZGVmYXVsdCkge1xuICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdChtb2RlbFNjaGVtYS5maWVsZHNbZmllbGRuYW1lXS5kZWZhdWx0KVxuICAgICAgICAgICYmICEobW9kZWxTY2hlbWEuZmllbGRzW2ZpZWxkbmFtZV0uZGVmYXVsdC4kZGJfZnVuY3Rpb24pKSB7XG4gICAgICAgIGlmIChbJ21hcCcsICdsaXN0JywgJ3NldCcsICdmcm96ZW4nXS5pbmRleE9mKG1vZGVsU2NoZW1hLmZpZWxkc1tmaWVsZG5hbWVdLnR5cGUpID4gLTEpIHJldHVybiB0cnVlO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH0sXG5cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gc2NoZW1lcjtcbiJdfQ==