'use strict';

var fs = require('fs');
var util = require('util');
var async = require('async');
var cql = require('dse-driver');
var _ = require('lodash');
var ORM = require('./orm/apollo');
var debug = require('debug')('express-cassandra');

var CassandraClient = function f(options) {
  var self = this;
  self.modelInstance = {};
  self.orm = new ORM(options.clientOptions, options.ormOptions);
};

CassandraClient.createClient = function (options) {
  return new CassandraClient(options);
};

CassandraClient.setDirectory = function (directory) {
  CassandraClient.directory = directory;
  return CassandraClient;
};

CassandraClient.bind = function (options, cb) {
  var self = CassandraClient;
  self.modelInstance = {};
  self.orm = new ORM(options.clientOptions, options.ormOptions);
  self.orm.connect(function (err) {
    if (err) {
      if (cb) cb(err);
      return;
    }

    fs.readdir(self.directory, function (err1, list) {
      if (err1) {
        if (cb) cb(err1);
        return;
      }

      async.each(list, function (file, callback) {
        var fileName = util.format('%s/%s', self.directory, file);
        var validFileExtensions = ['js', 'javascript', 'jsx', 'coffee', 'coffeescript', 'iced', 'script', 'ts', 'tsx', 'typescript', 'cjsx', 'co', 'json', 'json5', 'litcoffee', 'liticed', 'ls', 'node', 'toml', 'wisp'];
        var fileExtension = _.last(fileName.split('.')).toLowerCase();

        if (fileName.indexOf('Model') === -1 || validFileExtensions.indexOf(fileExtension) === -1) {
          callback();
          return;
        }

        var modelName = self._translateFileNameToModelName(file);

        if (modelName) {
          var modelSchema = require(fileName);
          self.modelInstance[modelName] = self.orm.add_model(modelName.toLowerCase(), modelSchema, function (err2) {
            if (err2) callback(err2);else callback();
          });
        } else {
          callback();
        }
      }, function (err3) {
        if (err3 && cb) {
          cb(err3);
        } else if (cb) {
          cb();
        }
      });
    });
  });
};

CassandraClient.prototype.connect = function f(callback) {
  var self = this;
  self.orm.connect(callback);
};

CassandraClient.prototype.loadSchema = function f(modelName, modelSchema, callback) {
  var self = this;
  self.modelInstance[modelName] = self.orm.add_model(modelName, modelSchema, callback);
  return self.modelInstance[modelName];
};

CassandraClient.uuid = function () {
  return cql.types.Uuid.random();
};

CassandraClient.uuidFromString = function (str) {
  return cql.types.Uuid.fromString(str);
};

CassandraClient.timeuuid = function () {
  return cql.types.TimeUuid.now();
};

CassandraClient.timeuuidFromDate = function (date) {
  return cql.types.TimeUuid.fromDate(date);
};

CassandraClient.timeuuidFromString = function (str) {
  return cql.types.TimeUuid.fromString(str);
};

CassandraClient.maxTimeuuid = function (date) {
  return cql.types.TimeUuid.max(date);
};

CassandraClient.minTimeuuid = function (date) {
  return cql.types.TimeUuid.min(date);
};

CassandraClient.prototype.doBatch = function f(queries, options, callback) {
  var randomModel = this.modelInstance[Object.keys(this.modelInstance)[0]];
  var builtQueries = [];
  for (var i = 0; i < queries.length; i++) {
    builtQueries.push({
      query: queries[i].query,
      params: queries[i].params
    });
  }
  if (builtQueries.length > 1) {
    randomModel.execute_batch(builtQueries, options, function (err) {
      if (err) callback(err);else callback();
    });
    return;
  }
  if (builtQueries.length > 0) {
    debug('single query provided for batch request, applying as non batch query');
    randomModel.execute_query(builtQueries[0].query, builtQueries[0].params, options, function (err) {
      if (err) callback(err);else callback();
    });
    return;
  }
  debug('no queries provided for batch request, empty array found, doing nothing');
  callback();
};

CassandraClient.doBatch = function f(queries, options, callback) {
  if (arguments.length === 2) {
    callback = options;
    options = { prepare: true };
  }
  CassandraClient.prototype.doBatch.call(CassandraClient, queries, options, callback);
};

CassandraClient._translateFileNameToModelName = function (fileName) {
  return fileName.slice(0, fileName.lastIndexOf('.')).replace('Model', '');
};

Object.defineProperties(CassandraClient, {
  consistencies: {
    get: function get() {
      return cql.types.consistencies;
    }
  },
  datatypes: {
    get: function get() {
      return cql.types;
    }
  },
  driver: {
    get: function get() {
      return cql;
    }
  },
  instance: {
    get: function get() {
      return CassandraClient.modelInstance;
    }
  },
  close: {
    get: function get() {
      return CassandraClient.orm.close;
    }
  }
});

Object.defineProperties(CassandraClient.prototype, {
  consistencies: {
    get: function get() {
      return cql.types.consistencies;
    }
  },
  datatypes: {
    get: function get() {
      return cql.types;
    }
  },
  driver: {
    get: function get() {
      return cql;
    }
  },
  instance: {
    get: function get() {
      return this.modelInstance;
    }
  },
  close: {
    get: function get() {
      return this.orm.close;
    }
  }
});

CassandraClient.prototype.uuid = CassandraClient.uuid;
CassandraClient.prototype.uuidFromString = CassandraClient.uuidFromString;
CassandraClient.prototype.timeuuid = CassandraClient.timeuuid;
CassandraClient.prototype.timeuuidFromDate = CassandraClient.timeuuidFromDate;
CassandraClient.prototype.timeuuidFromString = CassandraClient.timeuuidFromString;
CassandraClient.prototype.maxTimeuuid = CassandraClient.maxTimeuuid;
CassandraClient.prototype.minTimeuuid = CassandraClient.minTimeuuid;

CassandraClient.prototype._translateFileNameToModelName = CassandraClient._translateFileNameToModelName;

module.exports = CassandraClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9leHByZXNzQ2Fzc2FuZHJhLmpzIl0sIm5hbWVzIjpbImZzIiwicmVxdWlyZSIsInV0aWwiLCJhc3luYyIsImNxbCIsIl8iLCJPUk0iLCJkZWJ1ZyIsIkNhc3NhbmRyYUNsaWVudCIsImYiLCJvcHRpb25zIiwic2VsZiIsIm1vZGVsSW5zdGFuY2UiLCJvcm0iLCJjbGllbnRPcHRpb25zIiwib3JtT3B0aW9ucyIsImNyZWF0ZUNsaWVudCIsInNldERpcmVjdG9yeSIsImRpcmVjdG9yeSIsImJpbmQiLCJjYiIsImNvbm5lY3QiLCJlcnIiLCJyZWFkZGlyIiwiZXJyMSIsImxpc3QiLCJlYWNoIiwiZmlsZSIsImNhbGxiYWNrIiwiZmlsZU5hbWUiLCJmb3JtYXQiLCJ2YWxpZEZpbGVFeHRlbnNpb25zIiwiZmlsZUV4dGVuc2lvbiIsImxhc3QiLCJzcGxpdCIsInRvTG93ZXJDYXNlIiwiaW5kZXhPZiIsIm1vZGVsTmFtZSIsIl90cmFuc2xhdGVGaWxlTmFtZVRvTW9kZWxOYW1lIiwibW9kZWxTY2hlbWEiLCJhZGRfbW9kZWwiLCJlcnIyIiwiZXJyMyIsInByb3RvdHlwZSIsImxvYWRTY2hlbWEiLCJ1dWlkIiwidHlwZXMiLCJVdWlkIiwicmFuZG9tIiwidXVpZEZyb21TdHJpbmciLCJzdHIiLCJmcm9tU3RyaW5nIiwidGltZXV1aWQiLCJUaW1lVXVpZCIsIm5vdyIsInRpbWV1dWlkRnJvbURhdGUiLCJkYXRlIiwiZnJvbURhdGUiLCJ0aW1ldXVpZEZyb21TdHJpbmciLCJtYXhUaW1ldXVpZCIsIm1heCIsIm1pblRpbWV1dWlkIiwibWluIiwiZG9CYXRjaCIsInF1ZXJpZXMiLCJyYW5kb21Nb2RlbCIsIk9iamVjdCIsImtleXMiLCJidWlsdFF1ZXJpZXMiLCJpIiwibGVuZ3RoIiwicHVzaCIsInF1ZXJ5IiwicGFyYW1zIiwiZXhlY3V0ZV9iYXRjaCIsImV4ZWN1dGVfcXVlcnkiLCJhcmd1bWVudHMiLCJwcmVwYXJlIiwiY2FsbCIsInNsaWNlIiwibGFzdEluZGV4T2YiLCJyZXBsYWNlIiwiZGVmaW5lUHJvcGVydGllcyIsImNvbnNpc3RlbmNpZXMiLCJnZXQiLCJkYXRhdHlwZXMiLCJkcml2ZXIiLCJpbnN0YW5jZSIsImNsb3NlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFNQSxLQUFLQyxRQUFRLElBQVIsQ0FBWDtBQUNBLElBQU1DLE9BQU9ELFFBQVEsTUFBUixDQUFiO0FBQ0EsSUFBTUUsUUFBUUYsUUFBUSxPQUFSLENBQWQ7QUFDQSxJQUFNRyxNQUFNSCxRQUFRLFlBQVIsQ0FBWjtBQUNBLElBQU1JLElBQUlKLFFBQVEsUUFBUixDQUFWO0FBQ0EsSUFBTUssTUFBTUwsUUFBUSxjQUFSLENBQVo7QUFDQSxJQUFNTSxRQUFRTixRQUFRLE9BQVIsRUFBaUIsbUJBQWpCLENBQWQ7O0FBRUEsSUFBTU8sa0JBQWtCLFNBQVNDLENBQVQsQ0FBV0MsT0FBWCxFQUFvQjtBQUMxQyxNQUFNQyxPQUFPLElBQWI7QUFDQUEsT0FBS0MsYUFBTCxHQUFxQixFQUFyQjtBQUNBRCxPQUFLRSxHQUFMLEdBQVcsSUFBSVAsR0FBSixDQUFRSSxRQUFRSSxhQUFoQixFQUErQkosUUFBUUssVUFBdkMsQ0FBWDtBQUNELENBSkQ7O0FBTUFQLGdCQUFnQlEsWUFBaEIsR0FBK0IsVUFBQ04sT0FBRDtBQUFBLFNBQWMsSUFBSUYsZUFBSixDQUFvQkUsT0FBcEIsQ0FBZDtBQUFBLENBQS9COztBQUVBRixnQkFBZ0JTLFlBQWhCLEdBQStCLFVBQUNDLFNBQUQsRUFBZTtBQUM1Q1Ysa0JBQWdCVSxTQUFoQixHQUE0QkEsU0FBNUI7QUFDQSxTQUFPVixlQUFQO0FBQ0QsQ0FIRDs7QUFLQUEsZ0JBQWdCVyxJQUFoQixHQUF1QixVQUFDVCxPQUFELEVBQVVVLEVBQVYsRUFBaUI7QUFDdEMsTUFBTVQsT0FBT0gsZUFBYjtBQUNBRyxPQUFLQyxhQUFMLEdBQXFCLEVBQXJCO0FBQ0FELE9BQUtFLEdBQUwsR0FBVyxJQUFJUCxHQUFKLENBQVFJLFFBQVFJLGFB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QztBQVdqRHdDLFVBQVE7QUFDTkYsT0FETSxpQkFDQTtBQUNKLGFBQU9oRixHQUFQO0FBQ0Q7QUFISyxHQVh5QztBQWdCakRtRixZQUFVO0FBQ1JILE9BRFEsaUJBQ0Y7QUFDSixhQUFPLEtBQUt4RSxhQUFaO0FBQ0Q7QUFITyxHQWhCdUM7QUFxQmpENEUsU0FBTztBQUNMSixPQURLLGlCQUNDO0FBQ0osYUFBTyxLQUFLdkUsR0FBTCxDQUFTMkUsS0FBaEI7QUFDRDtBQUhJO0FBckIwQyxDQUFuRDs7QUE2QkFoRixnQkFBZ0JtQyxTQUFoQixDQUEwQkUsSUFBMUIsR0FBaUNyQyxnQkFBZ0JxQyxJQUFqRDtBQUNBckMsZ0JBQWdCbUMsU0FBaEIsQ0FBMEJNLGNBQTFCLEdBQTJDekMsZ0JBQWdCeUMsY0FBM0Q7QUFDQXpDLGdCQUFnQm1DLFNBQWhCLENBQTBCUyxRQUExQixHQUFxQzVDLGdCQUFnQjRDLFFBQXJEO0FBQ0E1QyxnQkFBZ0JtQyxTQUFoQixDQUEwQlksZ0JBQTFCLEdBQTZDL0MsZ0JBQWdCK0MsZ0JBQTdEO0FBQ0EvQyxnQkFBZ0JtQyxTQUFoQixDQUEwQmUsa0JBQTFCLEdBQStDbEQsZ0JBQWdCa0Qsa0JBQS9EO0FBQ0FsRCxnQkFBZ0JtQyxTQUFoQixDQUEwQmdCLFdBQTFCLEdBQXdDbkQsZ0JBQWdCbUQsV0FBeEQ7QUFDQW5ELGdCQUFnQm1DLFNBQWhCLENBQTBCa0IsV0FBMUIsR0FBd0NyRCxnQkFBZ0JxRCxXQUF4RDs7QUFFQXJELGdCQUFnQm1DLFNBQWhCLENBQTBCTCw2QkFBMUIsR0FBMEQ5QixnQkFBZ0I4Qiw2QkFBMUU7O0FBRUFtRCxPQUFPQyxPQUFQLEdBQWlCbEYsZUFBakIiLCJmaWxlIjoiZXhwcmVzc0Nhc3NhbmRyYS5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcbmNvbnN0IHV0aWwgPSByZXF1aXJlKCd1dGlsJyk7XG5jb25zdCBhc3luYyA9IHJlcXVpcmUoJ2FzeW5jJyk7XG5jb25zdCBjcWwgPSByZXF1aXJlKCdkc2UtZHJpdmVyJyk7XG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG5jb25zdCBPUk0gPSByZXF1aXJlKCcuL29ybS9hcG9sbG8nKTtcbmNvbnN0IGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKSgnZXhwcmVzcy1jYXNzYW5kcmEnKTtcblxuY29uc3QgQ2Fzc2FuZHJhQ2xpZW50ID0gZnVuY3Rpb24gZihvcHRpb25zKSB7XG4gIGNvbnN0IHNlbGYgPSB0aGlzO1xuICBzZWxmLm1vZGVsSW5zdGFuY2UgPSB7fTtcbiAgc2VsZi5vcm0gPSBuZXcgT1JNKG9wdGlvbnMuY2xpZW50T3B0aW9ucywgb3B0aW9ucy5vcm1PcHRpb25zKTtcbn07XG5cbkNhc3NhbmRyYUNsaWVudC5jcmVhdGVDbGllbnQgPSAob3B0aW9ucykgPT4gKG5ldyBDYXNzYW5kcmFDbGllbnQob3B0aW9ucykpO1xuXG5DYXNzYW5kcmFDbGllbnQuc2V0RGlyZWN0b3J5ID0gKGRpcmVjdG9yeSkgPT4ge1xuICBDYXNzYW5kcmFDbGllbnQuZGlyZWN0b3J5ID0gZGlyZWN0b3J5O1xuICByZXR1cm4gQ2Fzc2FuZHJhQ2xpZW50O1xufTtcblxuQ2Fzc2FuZHJhQ2xpZW50LmJpbmQgPSAob3B0aW9ucywgY2IpID0+IHtcbiAgY29uc3Qgc2VsZiA9IENhc3NhbmRyYUNsaWVudDtcbiAgc2VsZi5tb2RlbEluc3RhbmNlID0ge307XG4gIHNlbGYub3JtID0gbmV3IE9STShvcHRpb25zLmNsaWVudE9wdGlvbnMsIG9wdGlvbnMub3JtT3B0aW9ucyk7XG4gIHNlbGYub3JtLmNvbm5lY3QoKGVycikgPT4ge1xuICAgIGlmIChlcnIpIHtcbiAgICAgIGlmIChjYikgY2IoZXJyKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBmcy5yZWFkZGlyKHNlbGYuZGlyZWN0b3J5LCAoZXJyMSwgbGlzdCkgPT4ge1xuICAgICAgaWYgKGVycjEpIHtcbiAgICAgICAgaWYgKGNiKSBjYihlcnIxKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBhc3luYy5lYWNoKGxpc3QsIChmaWxlLCBjYWxsYmFjaykgPT4ge1xuICAgICAgICBjb25zdCBmaWxlTmFtZSA9IHV0aWwuZm9ybWF0KCclcy8lcycsIHNlbGYuZGlyZWN0b3J5LCBmaWxlKTtcbiAgICAgICAgY29uc3QgdmFsaWRGaWxlRXh0ZW5zaW9ucyA9IFtcbiAgICAgICAgICAnanMnLCAnamF2YXNjcmlwdCcsICdqc3gnLCAnY29mZmVlJywgJ2NvZmZlZXNjcmlwdCcsICdpY2VkJyxcbiAgICAgICAgICAnc2NyaXB0JywgJ3RzJywgJ3RzeCcsICd0eXBlc2NyaXB0JywgJ2Nqc3gnLCAnY28nLCAnanNvbicsXG4gICAgICAgICAgJ2pzb241JywgJ2xpdGNvZmZlZScsICdsaXRpY2VkJywgJ2xzJywgJ25vZGUnLCAndG9tbCcsICd3aXNwJyxcbiAgICAgICAgXTtcbiAgICAgICAgY29uc3QgZmlsZUV4dGVuc2lvbiA9IF8ubGFzdChmaWxlTmFtZS5zcGxpdCgnLicpKS50b0xvd2VyQ2FzZSgpO1xuXG4gICAgICAgIGlmIChmaWxlTmFtZS5pbmRleE9mKCdNb2RlbCcpID09PSAtMSB8fCB2YWxpZEZpbGVFeHRlbnNpb25zLmluZGV4T2YoZmlsZUV4dGVuc2lvbikgPT09IC0xKSB7XG4gICAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBtb2RlbE5hbWUgPSBzZWxmLl90cmFuc2xhdGVGaWxlTmFtZVRvTW9kZWxOYW1lKGZpbGUpO1xuXG4gICAgICAgIGlmIChtb2RlbE5hbWUpIHtcbiAgICAgICAgICBjb25zdCBtb2RlbFNjaGVtYSA9IHJlcXVpcmUoZmlsZU5hbWUpO1xuICAgICAgICAgIHNlbGYubW9kZWxJbnN0YW5jZVttb2RlbE5hbWVdID0gc2VsZi5vcm0uYWRkX21vZGVsKFxuICAgICAgICAgICAgbW9kZWxOYW1lLnRvTG93ZXJDYXNlKCksXG4gICAgICAgICAgICBtb2RlbFNjaGVtYSxcbiAgICAgICAgICAgIChlcnIyKSA9PiB7XG4gICAgICAgICAgICAgIGlmIChlcnIyKSBjYWxsYmFjayhlcnIyKTtcbiAgICAgICAgICAgICAgZWxzZSBjYWxsYmFjaygpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgICAgfVxuICAgICAgfSwgKGVycjMpID0+IHtcbiAgICAgICAgaWYgKGVycjMgJiYgY2IpIHtcbiAgICAgICAgICBjYihlcnIzKTtcbiAgICAgICAgfSBlbHNlIGlmIChjYikge1xuICAgICAgICAgIGNiKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcbn07XG5cbkNhc3NhbmRyYUNsaWVudC5wcm90b3R5cGUuY29ubmVjdCA9IGZ1bmN0aW9uIGYoY2FsbGJhY2spIHtcbiAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gIHNlbGYub3JtLmNvbm5lY3QoY2FsbGJhY2spO1xufTtcblxuQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS5sb2FkU2NoZW1hID0gZnVuY3Rpb24gZihtb2RlbE5hbWUsIG1vZGVsU2NoZW1hLCBjYWxsYmFjaykge1xuICBjb25zdCBzZWxmID0gdGhpcztcbiAgc2VsZi5tb2RlbEluc3RhbmNlW21vZGVsTmFtZV0gPSBzZWxmLm9ybS5hZGRfbW9kZWwoXG4gICAgbW9kZWxOYW1lLFxuICAgIG1vZGVsU2NoZW1hLFxuICAgIGNhbGxiYWNrXG4gICk7XG4gIHJldHVybiBzZWxmLm1vZGVsSW5zdGFuY2VbbW9kZWxOYW1lXTtcbn07XG5cbkNhc3NhbmRyYUNsaWVudC51dWlkID0gKCkgPT4gKGNxbC50eXBlcy5VdWlkLnJhbmRvbSgpKTtcblxuQ2Fzc2FuZHJhQ2xpZW50LnV1aWRGcm9tU3RyaW5nID0gKHN0cikgPT4gKGNxbC50eXBlcy5VdWlkLmZyb21TdHJpbmcoc3RyKSk7XG5cbkNhc3NhbmRyYUNsaWVudC50aW1ldXVpZCA9ICgpID0+IChjcWwudHlwZXMuVGltZVV1aWQubm93KCkpO1xuXG5DYXNzYW5kcmFDbGllbnQudGltZXV1aWRGcm9tRGF0ZSA9IChkYXRlKSA9PiAoY3FsLnR5cGVzLlRpbWVVdWlkLmZyb21EYXRlKGRhdGUpKTtcblxuQ2Fzc2FuZHJhQ2xpZW50LnRpbWV1dWlkRnJvbVN0cmluZyA9IChzdHIpID0+IChjcWwudHlwZXMuVGltZVV1aWQuZnJvbVN0cmluZyhzdHIpKTtcblxuQ2Fzc2FuZHJhQ2xpZW50Lm1heFRpbWV1dWlkID0gKGRhdGUpID0+IChjcWwudHlwZXMuVGltZVV1aWQubWF4KGRhdGUpKTtcblxuQ2Fzc2FuZHJhQ2xpZW50Lm1pblRpbWV1dWlkID0gKGRhdGUpID0+IChjcWwudHlwZXMuVGltZVV1aWQubWluKGRhdGUpKTtcblxuQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS5kb0JhdGNoID0gZnVuY3Rpb24gZihxdWVyaWVzLCBvcHRpb25zLCBjYWxsYmFjaykge1xuICBjb25zdCByYW5kb21Nb2RlbCA9IHRoaXMubW9kZWxJbnN0YW5jZVtPYmplY3Qua2V5cyh0aGlzLm1vZGVsSW5zdGFuY2UpWzBdXTtcbiAgY29uc3QgYnVpbHRRdWVyaWVzID0gW107XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgcXVlcmllcy5sZW5ndGg7IGkrKykge1xuICAgIGJ1aWx0UXVlcmllcy5wdXNoKHtcbiAgICAgIHF1ZXJ5OiBxdWVyaWVzW2ldLnF1ZXJ5LFxuICAgICAgcGFyYW1zOiBxdWVyaWVzW2ldLnBhcmFtcyxcbiAgICB9KTtcbiAgfVxuICBpZiAoYnVpbHRRdWVyaWVzLmxlbmd0aCA+IDEpIHtcbiAgICByYW5kb21Nb2RlbC5leGVjdXRlX2JhdGNoKGJ1aWx0UXVlcmllcywgb3B0aW9ucywgKGVycikgPT4ge1xuICAgICAgaWYgKGVycikgY2FsbGJhY2soZXJyKTtcbiAgICAgIGVsc2UgY2FsbGJhY2soKTtcbiAgICB9KTtcbiAgICByZXR1cm47XG4gIH1cbiAgaWYgKGJ1aWx0UXVlcmllcy5sZW5ndGggPiAwKSB7XG4gICAgZGVidWcoJ3NpbmdsZSBxdWVyeSBwcm92aWRlZCBmb3IgYmF0Y2ggcmVxdWVzdCwgYXBwbHlpbmcgYXMgbm9uIGJhdGNoIHF1ZXJ5Jyk7XG4gICAgcmFuZG9tTW9kZWwuZXhlY3V0ZV9xdWVyeShidWlsdFF1ZXJpZXNbMF0ucXVlcnksIGJ1aWx0UXVlcmllc1swXS5wYXJhbXMsIG9wdGlvbnMsIChlcnIpID0+IHtcbiAgICAgIGlmIChlcnIpIGNhbGxiYWNrKGVycik7XG4gICAgICBlbHNlIGNhbGxiYWNrKCk7XG4gICAgfSk7XG4gICAgcmV0dXJuO1xuICB9XG4gIGRlYnVnKCdubyBxdWVyaWVzIHByb3ZpZGVkIGZvciBiYXRjaCByZXF1ZXN0LCBlbXB0eSBhcnJheSBmb3VuZCwgZG9pbmcgbm90aGluZycpO1xuICBjYWxsYmFjaygpO1xufTtcblxuQ2Fzc2FuZHJhQ2xpZW50LmRvQmF0Y2ggPSBmdW5jdGlvbiBmKHF1ZXJpZXMsIG9wdGlvbnMsIGNhbGxiYWNrKSB7XG4gIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7XG4gICAgY2FsbGJhY2sgPSBvcHRpb25zO1xuICAgIG9wdGlvbnMgPSB7IHByZXBhcmU6IHRydWUgfTtcbiAgfVxuICBDYXNzYW5kcmFDbGllbnQucHJvdG90eXBlLmRvQmF0Y2guY2FsbChDYXNzYW5kcmFDbGllbnQsIHF1ZXJpZXMsIG9wdGlvbnMsIGNhbGxiYWNrKTtcbn07XG5cblxuQ2Fzc2FuZHJhQ2xpZW50Ll90cmFuc2xhdGVGaWxlTmFtZVRvTW9kZWxOYW1lID0gKGZpbGVOYW1lKSA9PiAoXG4gIGZpbGVOYW1lLnNsaWNlKDAsIGZpbGVOYW1lLmxhc3RJbmRleE9mKCcuJykpLnJlcGxhY2UoJ01vZGVsJywgJycpXG4pO1xuXG5cbk9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKENhc3NhbmRyYUNsaWVudCwge1xuICBjb25zaXN0ZW5jaWVzOiB7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIGNxbC50eXBlcy5jb25zaXN0ZW5jaWVzO1xuICAgIH0sXG4gIH0sXG4gIGRhdGF0eXBlczoge1xuICAgIGdldCgpIHtcbiAgICAgIHJldHVybiBjcWwudHlwZXM7XG4gICAgfSxcbiAgfSxcbiAgZHJpdmVyOiB7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIGNxbDtcbiAgICB9LFxuICB9LFxuICBpbnN0YW5jZToge1xuICAgIGdldCgpIHtcbiAgICAgIHJldHVybiBDYXNzYW5kcmFDbGllbnQubW9kZWxJbnN0YW5jZTtcbiAgICB9LFxuICB9LFxuICBjbG9zZToge1xuICAgIGdldCgpIHtcbiAgICAgIHJldHVybiBDYXNzYW5kcmFDbGllbnQub3JtLmNsb3NlO1xuICAgIH0sXG4gIH0sXG59KTtcblxuXG5PYmplY3QuZGVmaW5lUHJvcGVydGllcyhDYXNzYW5kcmFDbGllbnQucHJvdG90eXBlLCB7XG4gIGNvbnNpc3RlbmNpZXM6IHtcbiAgICBnZXQoKSB7XG4gICAgICByZXR1cm4gY3FsLnR5cGVzLmNvbnNpc3RlbmNpZXM7XG4gICAgfSxcbiAgfSxcbiAgZGF0YXR5cGVzOiB7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIGNxbC50eXBlcztcbiAgICB9LFxuICB9LFxuICBkcml2ZXI6IHtcbiAgICBnZXQoKSB7XG4gICAgICByZXR1cm4gY3FsO1xuICAgIH0sXG4gIH0sXG4gIGluc3RhbmNlOiB7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIHRoaXMubW9kZWxJbnN0YW5jZTtcbiAgICB9LFxuICB9LFxuICBjbG9zZToge1xuICAgIGdldCgpIHtcbiAgICAgIHJldHVybiB0aGlzLm9ybS5jbG9zZTtcbiAgICB9LFxuICB9LFxufSk7XG5cblxuQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS51dWlkID0gQ2Fzc2FuZHJhQ2xpZW50LnV1aWQ7XG5DYXNzYW5kcmFDbGllbnQucHJvdG90eXBlLnV1aWRGcm9tU3RyaW5nID0gQ2Fzc2FuZHJhQ2xpZW50LnV1aWRGcm9tU3RyaW5nO1xuQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS50aW1ldXVpZCA9IENhc3NhbmRyYUNsaWVudC50aW1ldXVpZDtcbkNhc3NhbmRyYUNsaWVudC5wcm90b3R5cGUudGltZXV1aWRGcm9tRGF0ZSA9IENhc3NhbmRyYUNsaWVudC50aW1ldXVpZEZyb21EYXRlO1xuQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS50aW1ldXVpZEZyb21TdHJpbmcgPSBDYXNzYW5kcmFDbGllbnQudGltZXV1aWRGcm9tU3RyaW5nO1xuQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS5tYXhUaW1ldXVpZCA9IENhc3NhbmRyYUNsaWVudC5tYXhUaW1ldXVpZDtcbkNhc3NhbmRyYUNsaWVudC5wcm90b3R5cGUubWluVGltZXV1aWQgPSBDYXNzYW5kcmFDbGllbnQubWluVGltZXV1aWQ7XG5cbkNhc3NhbmRyYUNsaWVudC5wcm90b3R5cGUuX3RyYW5zbGF0ZUZpbGVOYW1lVG9Nb2RlbE5hbWUgPSBDYXNzYW5kcmFDbGllbnQuX3RyYW5zbGF0ZUZpbGVOYW1lVG9Nb2RlbE5hbWU7XG5cbm1vZHVsZS5leHBvcnRzID0gQ2Fzc2FuZHJhQ2xpZW50O1xuIl19